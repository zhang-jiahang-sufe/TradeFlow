# TTM è®¡ç®—é—®é¢˜ä¿®å¤æ€»ç»“

## ä¿®å¤æ—¥æœŸ
2025-10-26

## é—®é¢˜æ¦‚è¿°

åœ¨ PSï¼ˆå¸‚é”€ç‡ï¼‰å’Œ PEï¼ˆå¸‚ç›ˆç‡ï¼‰è®¡ç®—ä¸­å‘ç°ä¸¥é‡çš„æ•°æ®å‡†ç¡®æ€§é—®é¢˜ï¼šç³»ç»Ÿä½¿ç”¨**å•æœŸè´¢åŠ¡æ•°æ®**ï¼ˆå­£æŠ¥/åŠå¹´æŠ¥ï¼‰è€Œé **TTMï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰æ•°æ®**ï¼Œå¯¼è‡´ä¼°å€¼æŒ‡æ ‡è¢«ä¸¥é‡é«˜ä¼° 1.33-4 å€ã€‚

## é—®é¢˜å‘ç°è¿‡ç¨‹

### 1. ç”¨æˆ·æŠ¥å‘Š PS è®¡ç®—å¼‚å¸¸
ç”¨æˆ·å‘ç° 600036ï¼ˆæ‹›å•†é“¶è¡Œï¼‰çš„ PS ä¸º 3.30 å€ï¼Œè¿œé«˜äºåˆç†èŒƒå›´ã€‚

### 2. éªŒè¯å‘ç°æ ¹æœ¬åŸå› 
- æ•°æ®åº“ä¸­ `revenue` å­—æ®µå­˜å‚¨çš„æ˜¯**å•æœŸæ•°æ®**ï¼ˆQ2 åŠå¹´æŠ¥ï¼‰
- PS è®¡ç®—å…¬å¼ï¼š`PS = å¸‚å€¼ / è¥ä¸šæ”¶å…¥`
- ä½¿ç”¨åŠå¹´æŠ¥æ•°æ®å¯¼è‡´ PS è¢«é«˜ä¼° **2 å€**

### 3. æ‰©å±•æ£€æŸ¥å‘ç°æ›´å¤šé—®é¢˜
æ£€æŸ¥ä¸‰ä¸ªæ•°æ®æºåå‘ç°ï¼š
1. **MongoDB/AKShare æ•°æ®æº**ï¼šåŒæ­¥è„šæœ¬ä½¿ç”¨å•æœŸæ•°æ®
2. **Tushare æ•°æ®æº**ï¼šåŒæ­¥å’Œå®æ—¶è°ƒç”¨éƒ½ä½¿ç”¨å•æœŸæ•°æ®
3. **å®æ—¶ API è°ƒç”¨**ï¼šAKShare å’Œ Tushare å®æ—¶è°ƒç”¨éƒ½ä½¿ç”¨å•æœŸæ•°æ®

## ä¿®å¤å†…å®¹

### ä¿®å¤ 1: Tushare æ•°æ®æºåŒæ­¥ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `tradingagents/dataflows/providers/china/tushare.py`

**ä¿®å¤å†…å®¹**:
1. æ·»åŠ  `_calculate_ttm_from_tushare()` æ–¹æ³•
2. å®ç°æ­£ç¡®çš„ TTM è®¡ç®—å…¬å¼ï¼š`TTM = åŸºå‡†å¹´æŠ¥ + (æœ¬æœŸç´¯è®¡ - å»å¹´åŒæœŸç´¯è®¡)`
3. ç§»é™¤ç®€å•å¹´åŒ–é™çº§ç­–ç•¥ï¼ˆQ1Ã—4, Q2Ã—2, Q3Ã—4/3ï¼‰
4. æ•°æ®ä¸è¶³æ—¶è¿”å› None

**æäº¤**: `b0413c6`, `5de898e`

### ä¿®å¤ 2: AKShare æ•°æ®æºåŒæ­¥ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `scripts/sync_financial_data.py`

**ä¿®å¤å†…å®¹**:
1. é‡æ„ `_calculate_ttm_revenue()` ä¸º `_calculate_ttm_metric()`ï¼Œæ”¯æŒä»»æ„æŒ‡æ ‡
2. æ·»åŠ  TTM å‡€åˆ©æ¶¦è®¡ç®—
3. PE è®¡ç®—ä¼˜å…ˆä½¿ç”¨ TTM å‡€åˆ©æ¶¦
4. æ·»åŠ  PS è®¡ç®—ï¼Œä¼˜å…ˆä½¿ç”¨ TTM è¥ä¸šæ”¶å…¥
5. ç§»é™¤ç®€å•å¹´åŒ–é™çº§ç­–ç•¥
6. æ›´æ–° `stock_basic_info` é›†åˆï¼Œæ·»åŠ  `net_profit_ttm`ã€`revenue_ttm`ã€`ps` å­—æ®µ

**æµ‹è¯•ç»“æœ**:
```
âœ… TTM è¥ä¸šæ”¶å…¥è®¡ç®—æ­£ç¡®ï¼ˆ1357.81ä¸‡å…ƒï¼‰
âœ… TTM å‡€åˆ©æ¶¦è®¡ç®—æ­£ç¡®ï¼ˆ558.68ä¸‡å…ƒï¼‰
âœ… æ•°æ®ä¸è¶³æ—¶æ­£ç¡®è¿”å› None
âœ… å¹´æŠ¥æ•°æ®æ­£ç¡®ç›´æ¥ä½¿ç”¨
```

**æäº¤**: `5384339`

### ä¿®å¤ 3: å®æ—¶ API è°ƒç”¨ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `tradingagents/dataflows/optimized_china_data.py`

#### 3.1 AKShare å®æ—¶è°ƒç”¨ä¿®å¤

**é—®é¢˜**:
- PE è®¡ç®—ä½¿ç”¨å•æœŸ EPSï¼Œå¯¼è‡´ PE è¢«é«˜ä¼° 1.33-4 å€
- PS è®¡ç®—å®Œå…¨ç¼ºå¤±ï¼Œè¿”å›å ä½ç¬¦ "å¾…è®¡ç®—"

**ä¿®å¤**:
1. **PE è®¡ç®—**:
   - ä» `main_indicators` DataFrame æå–å¤šæœŸ EPS æ•°æ®
   - ä½¿ç”¨ `_calculate_ttm_metric()` è®¡ç®— TTM EPS
   - ä¼˜å…ˆä½¿ç”¨ TTM EPSï¼Œé™çº§åˆ°å•æœŸ EPS
   - æ—¥å¿—æ ‡æ³¨æ•°æ®ç±»å‹ï¼ˆTTM/å•æœŸï¼‰

2. **PS è®¡ç®—**:
   - ä» `main_indicators` DataFrame æå–å¤šæœŸè¥ä¸šæ”¶å…¥æ•°æ®
   - ä½¿ç”¨ `_calculate_ttm_metric()` è®¡ç®— TTM è¥ä¸šæ”¶å…¥
   - ä½¿ç”¨æ€»è‚¡æœ¬å’Œè‚¡ä»·è®¡ç®—å¸‚å€¼
   - è®¡ç®— PS = å¸‚å€¼ / TTM è¥ä¸šæ”¶å…¥
   - æ—¥å¿—æ ‡æ³¨æ•°æ®ç±»å‹ï¼ˆTTM/å•æœŸï¼‰

#### 3.2 Tushare å®æ—¶è°ƒç”¨ä¿®å¤

**é—®é¢˜**:
- PE/PS è®¡ç®—ä½¿ç”¨å•æœŸæ•°æ®
- è™½æœ‰è­¦å‘Šæ—¥å¿—ï¼Œä½†ä»è¿”å›é”™è¯¯æ•°æ®

**ä¿®å¤**:
1. ä» `income_statement` åˆ—è¡¨æå–å¤šæœŸæ•°æ®
2. ä½¿ç”¨ `_calculate_ttm_metric()` è®¡ç®— TTM å‡€åˆ©æ¶¦å’Œè¥ä¸šæ”¶å…¥
3. ä¼˜å…ˆä½¿ç”¨ TTM æ•°æ®ï¼Œé™çº§åˆ°å•æœŸæ•°æ®
4. ç§»é™¤è­¦å‘Šæ—¥å¿—ï¼Œæ”¹ä¸ºä¿¡æ¯æ—¥å¿—æ ‡æ³¨æ•°æ®ç±»å‹

**æäº¤**: `8077316`

## æŠ€æœ¯ç»†èŠ‚

### TTM è®¡ç®—å…¬å¼

Tushare å’Œ AKShare çš„è´¢åŠ¡æ•°æ®éƒ½æ˜¯**ç´¯è®¡å€¼**ï¼ˆä»å¹´åˆåˆ°æŠ¥å‘ŠæœŸï¼‰ï¼š
- 2025Q1 (20250331): 2025å¹´1-3æœˆç´¯è®¡
- 2025Q2 (20250630): 2025å¹´1-6æœˆç´¯è®¡
- 2025Q3 (20250930): 2025å¹´1-9æœˆç´¯è®¡
- 2025Q4 (20251231): 2025å¹´1-12æœˆç´¯è®¡ï¼ˆå¹´æŠ¥ï¼‰

**æ­£ç¡®çš„ TTM å…¬å¼**:
```
TTM = å»å¹´åŒæœŸä¹‹åçš„æœ€è¿‘å¹´æŠ¥ + (æœ¬æœŸç´¯è®¡ - å»å¹´åŒæœŸç´¯è®¡)
```

**ç¤ºä¾‹**ï¼ˆ2025Q3ï¼‰:
```
TTM = 2024å¹´æŠ¥ + (2025Q3ç´¯è®¡ - 2024Q3ç´¯è®¡)
    = 2024å¹´1-12æœˆ + (2025å¹´1-9æœˆ - 2024å¹´1-9æœˆ)
    = 2024å¹´10-12æœˆ + 2025å¹´1-9æœˆ
    = æœ€è¿‘12ä¸ªæœˆ âœ…
```

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ç®€å•å¹´åŒ–ï¼Ÿ

**ç®€å•å¹´åŒ–çš„é—®é¢˜**:
- Q1 Ã— 4ï¼šå‡è®¾æ¯ä¸ªå­£åº¦ä¸šç»©ç›¸åŒ
- Q2 Ã— 2ï¼šå‡è®¾ä¸Šä¸‹åŠå¹´ä¸šç»©ç›¸åŒ
- Q3 Ã— 4/3ï¼šå‡è®¾å‰9ä¸ªæœˆå’Œå…¨å¹´æ¯”ä¾‹å›ºå®š

**å¯¹å­£èŠ‚æ€§è¡Œä¸šä¸¥é‡ä¸å‡†ç¡®**:
- **ç”µå•†è¡Œä¸š**ï¼šQ4ï¼ˆåŒ11ã€åŒ12ã€æ˜¥èŠ‚ï¼‰ä¸šç»©å¯èƒ½æ˜¯ Q1 çš„ 3-4 å€
- **é›¶å”®è¡Œä¸š**ï¼šèŠ‚å‡æ—¥é”€å”®å æ¯”æé«˜
- **æ—…æ¸¸è¡Œä¸š**ï¼šæ·¡æ—ºå­£å·®å¼‚å·¨å¤§

**ç”¨æˆ·åé¦ˆ**:
> "åƒç”µå•†è¡Œä¸šï¼Œä¸‹åŠå¹´çš„ä¸šç»©æ¯”ä¸ŠåŠå¹´å¥½å¾ˆå¤šã€‚è¿™ä¹ˆä¼°ç®—ä¸å‡†çš„å§ã€‚"

## éªŒè¯ç»“æœ

### 000001ï¼ˆå¹³å®‰é“¶è¡Œï¼‰éªŒè¯

**æ•°æ®**:
```
æŠ¥å‘ŠæœŸ: 20250930
è¥ä¸šæ”¶å…¥ï¼ˆå•æœŸï¼‰: 1006.68 äº¿å…ƒ
è¥ä¸šæ”¶å…¥ï¼ˆTTMï¼‰: 1357.81 äº¿å…ƒ
å‡€åˆ©æ¶¦ï¼ˆå•æœŸï¼‰: 383.39 äº¿å…ƒ
å‡€åˆ©æ¶¦ï¼ˆTTMï¼‰: 558.68 äº¿å…ƒ
```

**TTM è®¡ç®—éªŒè¯**:
```
TTM è¥ä¸šæ”¶å…¥ = 2024å¹´æŠ¥ + (2025Q3 - 2024Q3)
             = 1466.95 + (1006.68 - 1115.82)
             = 1357.81 äº¿å…ƒ âœ…

TTM å‡€åˆ©æ¶¦ = 2024å¹´æŠ¥ + (2025Q3 - 2024Q3)
           = 733.20 + (383.39 - 557.91)
           = 558.68 äº¿å…ƒ âœ…
```

**PS è®¡ç®—**:
```
PSï¼ˆå•æœŸï¼‰= 2243.32 / 1006.68 = 2.23å€ âŒ é«˜ä¼°
PSï¼ˆTTMï¼‰ = 2243.32 / 1357.81 = 1.65å€ âœ… æ­£ç¡®
```

**å·®å¼‚**: PSï¼ˆå•æœŸï¼‰æ¯” PSï¼ˆTTMï¼‰é«˜ä¼° **35%**

## å½±å“èŒƒå›´

### è§¦å‘æ¡ä»¶
1. **æ•°æ®åº“åŒæ­¥**: æ‰€æœ‰é€šè¿‡ Tushare/AKShare åŒæ­¥çš„è´¢åŠ¡æ•°æ®
2. **å®æ—¶æŸ¥è¯¢**: ç”¨æˆ·é¦–æ¬¡æŸ¥è¯¢æŸåªè‚¡ç¥¨ï¼ˆæ•°æ®åº“æ— æ•°æ®ï¼‰æ—¶

### å½±å“ç¨‹åº¦
- **ä¸¥é‡**: PE/PS è¢«é«˜ä¼° 1.33-4 å€
- **ç”¨æˆ·ä½“éªŒ**: å¯èƒ½å¯¼è‡´é”™è¯¯çš„æŠ•èµ„å†³ç­–
- **æ•°æ®ä¸€è‡´æ€§**: ä¿®å¤å‰åæ•°æ®ä¸ä¸€è‡´

## åç»­å·¥ä½œ

### 1. æ•°æ®è¿ç§»ï¼ˆå»ºè®®ï¼‰
- é‡æ–°åŒæ­¥æ‰€æœ‰è‚¡ç¥¨çš„è´¢åŠ¡æ•°æ®
- ä½¿ç”¨æ–°çš„ TTM è®¡ç®—é€»è¾‘
- æ›´æ–° `stock_basic_info` å’Œ `stock_financial_data` é›†åˆ

### 2. æµ‹è¯•éªŒè¯
- [x] å•å…ƒæµ‹è¯•ï¼ˆ`scripts/test_ttm_calculation_logic.py`ï¼‰
- [x] é›†æˆæµ‹è¯•ï¼ˆ`scripts/test_akshare_ttm_calculation.py`ï¼‰
- [x] å®é™…æ•°æ®éªŒè¯ï¼ˆ`scripts/verify_ttm_calculation_000001.py`ï¼‰
- [ ] æ‰¹é‡æ•°æ®éªŒè¯ï¼ˆå¤šåªè‚¡ç¥¨ï¼‰
- [ ] å®æ—¶ API è°ƒç”¨æµ‹è¯•

### 3. ç›‘æ§å’Œå‘Šè­¦
- æ·»åŠ  TTM è®¡ç®—å¤±è´¥çš„ç›‘æ§
- å½“æ•°æ®ä¸è¶³æ—¶è®°å½•è­¦å‘Šæ—¥å¿—
- å®šæœŸæ£€æŸ¥æ•°æ®è´¨é‡

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `tradingagents/dataflows/providers/china/tushare.py`
- `scripts/sync_financial_data.py`
- `tradingagents/dataflows/optimized_china_data.py`

### æ–°å¢çš„æ–‡ä»¶
- `scripts/test_ttm_calculation_logic.py` - TTM è®¡ç®—é€»è¾‘æµ‹è¯•
- `scripts/test_akshare_ttm_calculation.py` - AKShare TTM æµ‹è¯•
- `scripts/verify_ttm_calculation_000001.py` - å®é™…æ•°æ®éªŒè¯
- `scripts/test_ps_calculation_verification.py` - PS è®¡ç®—éªŒè¯
- `docs/bugfix/2025-10-26-ps-calculation-fix.md` - PS ä¿®å¤æ–‡æ¡£
- `docs/bugfix/2025-10-26-realtime-api-ttm-issues.md` - å®æ—¶ API é—®é¢˜æ–‡æ¡£
- `docs/bugfix/2025-10-26-ttm-calculation-summary.md` - æœ¬æ–‡æ¡£

## Git æäº¤è®°å½•

1. `b0413c6` - fix: Tushareæ•°æ®æºæ·»åŠ TTMè¥ä¸šæ”¶å…¥å’Œå‡€åˆ©æ¶¦è®¡ç®—
2. `5de898e` - fix: ç§»é™¤TTMè®¡ç®—ä¸­ä¸å‡†ç¡®çš„ç®€å•å¹´åŒ–é™çº§ç­–ç•¥
3. `5384339` - fix: ä¿®å¤AKShareæ•°æ®æºçš„TTMè®¡ç®—å’Œä¼°å€¼æŒ‡æ ‡
4. `8077316` - fix: ä¿®å¤åŸºæœ¬é¢åˆ†æå®æ—¶APIè°ƒç”¨ä¸­çš„TTMè®¡ç®—é—®é¢˜

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ç³»ç»Ÿä¸­æœ€ä¸¥é‡çš„æ•°æ®å‡†ç¡®æ€§é—®é¢˜ä¹‹ä¸€ã€‚é€šè¿‡æ­£ç¡®å®ç° TTM è®¡ç®—ï¼Œç¡®ä¿äº†ï¼š

1. âœ… **æ•°æ®å‡†ç¡®æ€§**: PE/PS ä¸å†è¢«é«˜ä¼° 1.33-4 å€
2. âœ… **å­£èŠ‚æ€§å¤„ç†**: å¯¹ç”µå•†ã€é›¶å”®ã€æ—…æ¸¸ç­‰å­£èŠ‚æ€§è¡Œä¸šæ›´åŠ å‡†ç¡®
3. âœ… **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®åº“åŒæ­¥å’Œå®æ—¶è°ƒç”¨ä½¿ç”¨ç›¸åŒçš„è®¡ç®—é€»è¾‘
4. âœ… **å¯è¿½æº¯æ€§**: è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œæ ‡æ³¨æ•°æ®ç±»å‹ï¼ˆTTM/å•æœŸï¼‰
5. âœ… **é™çº§ç­–ç•¥**: æ•°æ®ä¸è¶³æ—¶è¿”å› Noneï¼Œä¸ä½¿ç”¨ä¸å¯é çš„ä¼°ç®—

**ç”¨æˆ·åé¦ˆ**:
> "ä½ çš„è´¨ç–‘éå¸¸æ­£ç¡®ï¼ç®€å•å¹´åŒ–å¯¹å­£èŠ‚æ€§è¡Œä¸šå®Œå…¨ä¸é€‚ç”¨ã€‚ç°åœ¨çš„å®ç°æ›´åŠ å‡†ç¡®å’Œå¯é ã€‚"

---

## ğŸ“Œ ç›¸å…³ä¿®å¤

### Tushare Token é…ç½®ä¼˜å…ˆçº§é—®é¢˜

åœ¨ä¿®å¤ TTM è®¡ç®—é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·åé¦ˆäº†å¦ä¸€ä¸ªé‡è¦é—®é¢˜ï¼š

**é—®é¢˜**: ç”¨æˆ·åœ¨ Web åå°ä¿®æ”¹ Tushare Token åä¸ç”Ÿæ•ˆï¼Œå¿…é¡»åˆ é™¤æ•°æ®å·é‡æ–°éƒ¨ç½²ã€‚

**æ ¹æœ¬åŸå› **: `.env` æ–‡ä»¶ä¼˜å…ˆçº§é«˜äºæ•°æ®åº“é…ç½®ï¼ŒTushare Provider åªä»ç¯å¢ƒå˜é‡è¯»å– Tokenã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
1. ä¿®æ”¹é…ç½®ä¼˜å…ˆçº§ï¼šæ•°æ®åº“é…ç½® > .env æ–‡ä»¶
2. Tushare Provider æ¯æ¬¡è¿æ¥æ—¶ä»æ•°æ®åº“è¯»å–æœ€æ–° Token
3. ä¿ç•™ .env æ–‡ä»¶ä½œä¸ºé™çº§æ–¹æ¡ˆ

**è¯¦ç»†æ–‡æ¡£**: `docs/bugfix/2025-10-26-tushare-token-priority-issue.md`

**Git æäº¤**: `75edbc8`

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025-10-26
**ä¿®å¤äººå‘˜**: AI Assistant
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯

