# å¤§æ¨¡å‹é…ç½®æµ‹è¯•åŠŸèƒ½ä¿®å¤è¯´æ˜

> **ä¿®å¤ç‰ˆæœ¬**: v1.0.0-preview  
> **ä¿®å¤æ—¥æœŸ**: 2025-10-21  
> **é—®é¢˜ç¼–å·**: #ç”¨æˆ·åé¦ˆ

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ

ç”¨æˆ·åœ¨"å¤§æ¨¡å‹é…ç½®"é¡µé¢å¡«å†™é…ç½®æ—¶ï¼Œå‘ç°**å¡«å†™ä»»æ„APIåŸºç¡€URLï¼ˆå¦‚ `http://127.0.0.1`ï¼‰éƒ½èƒ½æµ‹è¯•æˆåŠŸ**ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚

### é—®é¢˜æˆªå›¾

ç”¨æˆ·å¡«å†™äº† `http://127.0.0.1` ä½œä¸ºAPIåŸºç¡€URLï¼Œç‚¹å‡»æµ‹è¯•åæ˜¾ç¤º"æµ‹è¯•æˆåŠŸ"ã€‚

### æ ¹æœ¬åŸå› 

æ£€æŸ¥ä»£ç åå‘ç°ï¼Œ`app/services/config_service.py` ä¸­çš„ `test_llm_config` æ–¹æ³•**åªæ˜¯æ¨¡æ‹Ÿæµ‹è¯•**ï¼š

```python
async def test_llm_config(self, llm_config: LLMConfig) -> Dict[str, Any]:
    """æµ‹è¯•å¤§æ¨¡å‹é…ç½®"""
    start_time = time.time()
    try:
        # è¿™é‡Œåº”è¯¥å®é™…è°ƒç”¨LLM APIè¿›è¡Œæµ‹è¯•
        # ç›®å‰è¿”å›æ¨¡æ‹Ÿç»“æœ
        await asyncio.sleep(1)  # æ¨¡æ‹ŸAPIè°ƒç”¨  âŒ åªæ˜¯ sleepï¼Œæ²¡æœ‰çœŸæ­£æµ‹è¯•ï¼
        
        return {
            "success": True,  # âŒ æ°¸è¿œè¿”å›æˆåŠŸï¼
            "message": f"æˆåŠŸè¿æ¥åˆ° {provider_str} {llm_config.model_name}",
            ...
        }
```

**é—®é¢˜**ï¼š
1. âŒ æ²¡æœ‰çœŸæ­£è°ƒç”¨APIè¿›è¡ŒéªŒè¯
2. âŒ æ²¡æœ‰éªŒè¯APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®
3. âŒ æ²¡æœ‰éªŒè¯APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
4. âŒ æ°¸è¿œè¿”å›æˆåŠŸï¼Œæ— è®ºé…ç½®æ˜¯å¦æ­£ç¡®

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å®ç°çœŸå®çš„APIè°ƒç”¨æµ‹è¯•

ä¿®æ”¹åçš„ `test_llm_config` æ–¹æ³•ä¼šï¼š

1. **éªŒè¯å¿…éœ€å­—æ®µ**ï¼š
   - æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦ä¸ºç©º
   - æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ

2. **æ„å»ºçœŸå®çš„APIè¯·æ±‚**ï¼š
   ```python
   # æ„å»ºæ ‡å‡†çš„ OpenAI å…¼å®¹ API è¯·æ±‚
   url = f"{api_base}/v1/chat/completions"
   
   headers = {
       "Content-Type": "application/json",
       "Authorization": f"Bearer {api_key}"
   }
   
   data = {
       "model": llm_config.model_name,
       "messages": [
           {"role": "user", "content": "Hello, please respond with 'OK' if you can read this."}
       ],
       "max_tokens": 10,
       "temperature": 0.1
   }
   ```

3. **å‘é€HTTPè¯·æ±‚å¹¶éªŒè¯å“åº”**ï¼š
   ```python
   response = requests.post(url, json=data, headers=headers, timeout=15)
   
   if response.status_code == 200:
       # éªŒè¯å“åº”å†…å®¹
       result = response.json()
       if "choices" in result and len(result["choices"]) > 0:
           content = result["choices"][0]["message"]["content"]
           if content and len(content.strip()) > 0:
               return {"success": True, ...}  # âœ… çœŸæ­£çš„æˆåŠŸ
   ```

### 2. å¢å¼ºé”™è¯¯å¤„ç†

ä¿®å¤åä¼šåŒºåˆ†ä¸åŒçš„é”™è¯¯æƒ…å†µï¼š

| HTTPçŠ¶æ€ç  | é”™è¯¯ä¿¡æ¯ |
|-----------|---------|
| 401 | APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ |
| 403 | APIæƒé™ä¸è¶³æˆ–é…é¢å·²ç”¨å®Œ |
| 404 | APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡® |
| Timeout | è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œæ˜¯å¦å¯è¾¾ |
| ConnectionError | è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡® |

### 3. æ”¹è¿›APIå¯†é’¥éªŒè¯

å¢å¼º `_is_valid_api_key` æ–¹æ³•ï¼Œå¢åŠ æˆªæ–­å¯†é’¥æ£€æµ‹ï¼š

```python
def _is_valid_api_key(self, api_key: Optional[str]) -> bool:
    """åˆ¤æ–­ API Key æ˜¯å¦æœ‰æ•ˆ"""
    if not api_key:
        return False
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºæˆªæ–­çš„å¯†é’¥ï¼ˆåŒ…å« '...'ï¼‰
    if '...' in api_key:
        return False  # âŒ æˆªæ–­çš„å¯†é’¥æ— æ•ˆ
    
    # æ£€æŸ¥é•¿åº¦
    if len(api_key) <= 10:
        return False
    
    return True
```

### 4. è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

ä¿®å¤åä¼šè¾“å‡ºè¯¦ç»†çš„æµ‹è¯•æ—¥å¿—ï¼š

```
ğŸ§ª æµ‹è¯•å¤§æ¨¡å‹é…ç½®: dashscope - qwen-max
ğŸ“ APIåŸºç¡€URL: http://127.0.0.1
âœ… ä»å‚å®¶é…ç½®è·å–åˆ°APIå¯†é’¥
ğŸŒ å‘é€æµ‹è¯•è¯·æ±‚åˆ°: http://127.0.0.1/v1/chat/completions
ğŸ“¡ æ”¶åˆ°å“åº”: HTTP 404
âŒ æµ‹è¯•å¤±è´¥: APIç«¯ç‚¹ä¸å­˜åœ¨
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£ç¡®çš„é…ç½® âœ…

**è¾“å…¥**ï¼š
- APIåŸºç¡€URL: `https://dashscope.aliyuncs.com/compatible-mode/v1`
- æ¨¡å‹ä»£ç : `qwen-max`
- å‚å®¶å·²é…ç½®æœ‰æ•ˆçš„APIå¯†é’¥

**é¢„æœŸç»“æœ**ï¼š
```
âœ… æµ‹è¯•æˆåŠŸ
æˆåŠŸè¿æ¥åˆ° dashscope qwen-max
å“åº”æ—¶é—´: 1.2ç§’
```

### åœºæ™¯2ï¼šé”™è¯¯çš„APIåŸºç¡€URL âŒ

**è¾“å…¥**ï¼š
- APIåŸºç¡€URL: `http://127.0.0.1`
- æ¨¡å‹ä»£ç : `qwen-max`

**é¢„æœŸç»“æœ**ï¼š
```
âŒ æµ‹è¯•å¤±è´¥
è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®: Connection refused
```

### åœºæ™¯3ï¼šç©ºçš„APIåŸºç¡€URL âŒ

**è¾“å…¥**ï¼š
- APIåŸºç¡€URL: ï¼ˆç©ºï¼‰
- æ¨¡å‹ä»£ç : `qwen-max`

**é¢„æœŸç»“æœ**ï¼š
```
âŒ æµ‹è¯•å¤±è´¥
APIåŸºç¡€URLä¸èƒ½ä¸ºç©º
```

### åœºæ™¯4ï¼šæ— æ•ˆçš„APIå¯†é’¥ âŒ

**è¾“å…¥**ï¼š
- APIåŸºç¡€URL: `https://dashscope.aliyuncs.com/compatible-mode/v1`
- æ¨¡å‹ä»£ç : `qwen-max`
- å‚å®¶æœªé…ç½®APIå¯†é’¥æˆ–å¯†é’¥æ— æ•ˆ

**é¢„æœŸç»“æœ**ï¼š
```
âŒ æµ‹è¯•å¤±è´¥
dashscope æœªé…ç½®æœ‰æ•ˆçš„APIå¯†é’¥
```

### åœºæ™¯5ï¼šæˆªæ–­çš„APIå¯†é’¥ âŒ

**è¾“å…¥**ï¼š
- å‚å®¶é…ç½®ä¸­æ˜¾ç¤ºçš„å¯†é’¥: `sk-99054...`ï¼ˆæˆªæ–­æ˜¾ç¤ºï¼‰

**é¢„æœŸç»“æœ**ï¼š
```
âŒ æµ‹è¯•å¤±è´¥
dashscope æœªé…ç½®æœ‰æ•ˆçš„APIå¯†é’¥
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¦‚ä½•æµ‹è¯•å¤§æ¨¡å‹é…ç½®

1. **æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå•"è®¾ç½®" â†’ "é…ç½®ç®¡ç†"

2. **é€‰æ‹©å¤§æ¨¡å‹é…ç½®**
   - ç‚¹å‡»"å¤§æ¨¡å‹é…ç½®"æ ‡ç­¾é¡µ

3. **ç¼–è¾‘æˆ–æ·»åŠ æ¨¡å‹é…ç½®**
   - ç‚¹å‡»"æ·»åŠ æ¨¡å‹"æˆ–ç¼–è¾‘ç°æœ‰æ¨¡å‹
   - å¡«å†™å¿…éœ€å­—æ®µï¼š
     - ä¾›åº”å•†ï¼šé€‰æ‹©å‚å®¶ï¼ˆå¦‚"é˜¿é‡Œäº‘ç™¾ç‚¼"ï¼‰
     - é€‰æ‹©æ¨¡å‹ï¼šä»åˆ—è¡¨ä¸­é€‰æ‹©æ¨¡å‹
     - æ¨¡å‹ä»£ç ï¼šå¡«å†™å®é™…çš„æ¨¡å‹æ ‡è¯†ç¬¦ï¼ˆå¦‚ `qwen-max`ï¼‰
     - **APIåŸºç¡€URL**ï¼šå¡«å†™æ­£ç¡®çš„APIç«¯ç‚¹åœ°å€

4. **ç‚¹å‡»"æµ‹è¯•"æŒ‰é’®**
   - ç³»ç»Ÿä¼šå‘é€çœŸå®çš„APIè¯·æ±‚è¿›è¡ŒéªŒè¯
   - ç­‰å¾…æµ‹è¯•ç»“æœï¼ˆé€šå¸¸1-3ç§’ï¼‰

5. **æŸ¥çœ‹æµ‹è¯•ç»“æœ**
   - âœ… æˆåŠŸï¼šæ˜¾ç¤º"æµ‹è¯•æˆåŠŸ"æ¶ˆæ¯
   - âŒ å¤±è´¥ï¼šæ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•

#### é”™è¯¯1ï¼šAPIç«¯ç‚¹ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®: http://127.0.0.1/v1/chat/completions
```

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®
- å‚è€ƒå‚å®¶æ–‡æ¡£è·å–æ­£ç¡®çš„APIç«¯ç‚¹
- å¸¸è§çš„æ­£ç¡®æ ¼å¼ï¼š
  - é˜¿é‡Œç™¾ç‚¼ï¼š`https://dashscope.aliyuncs.com/compatible-mode/v1`
  - DeepSeekï¼š`https://api.deepseek.com`
  - OpenAIï¼š`https://api.openai.com/v1`

#### é”™è¯¯2ï¼šè¿æ¥è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**ï¼š
```
è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œæ˜¯å¦å¯è¾¾
```

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å¦‚æœæ˜¯å›½å¤–APIï¼ˆOpenAIã€Google AIï¼‰ï¼Œéœ€è¦é…ç½®ä»£ç†
- å‚è€ƒï¼š[ä»£ç†é…ç½®æŒ‡å—](./proxy-configuration.md)

#### é”™è¯¯3ï¼šAPIå¯†é’¥æ— æ•ˆ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ
```

**è§£å†³æ–¹æ³•**ï¼š
- åœ¨"å‚å®¶ç®¡ç†"ä¸­æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤APIå¯†é’¥æœªè¿‡æœŸ
- é‡æ–°ç”ŸæˆAPIå¯†é’¥å¹¶æ›´æ–°é…ç½®

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### APIæµ‹è¯•æµç¨‹

```mermaid
graph TD
    A[å¼€å§‹æµ‹è¯•] --> B{éªŒè¯APIåŸºç¡€URL}
    B -->|ä¸ºç©º| C[è¿”å›é”™è¯¯: URLä¸èƒ½ä¸ºç©º]
    B -->|æœ‰æ•ˆ| D{è·å–APIå¯†é’¥}
    D -->|ä»é…ç½®è·å–| E{éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§}
    D -->|ä»ç¯å¢ƒå˜é‡è·å–| E
    E -->|æ— æ•ˆ| F[è¿”å›é”™è¯¯: å¯†é’¥æ— æ•ˆ]
    E -->|æœ‰æ•ˆ| G[æ„å»ºAPIè¯·æ±‚]
    G --> H[å‘é€HTTPè¯·æ±‚]
    H --> I{æ£€æŸ¥å“åº”çŠ¶æ€}
    I -->|200| J{éªŒè¯å“åº”å†…å®¹}
    I -->|401| K[è¿”å›é”™è¯¯: å¯†é’¥æ— æ•ˆ]
    I -->|403| L[è¿”å›é”™è¯¯: æƒé™ä¸è¶³]
    I -->|404| M[è¿”å›é”™è¯¯: ç«¯ç‚¹ä¸å­˜åœ¨]
    I -->|è¶…æ—¶| N[è¿”å›é”™è¯¯: è¿æ¥è¶…æ—¶]
    I -->|è¿æ¥å¤±è´¥| O[è¿”å›é”™è¯¯: è¿æ¥å¤±è´¥]
    J -->|æœ‰å†…å®¹| P[è¿”å›æˆåŠŸ]
    J -->|æ— å†…å®¹| Q[è¿”å›é”™è¯¯: å“åº”ä¸ºç©º]
```

### ä»£ç ä½ç½®

- **æµ‹è¯•æ–¹æ³•**ï¼š`app/services/config_service.py` â†’ `test_llm_config()`
- **APIç«¯ç‚¹**ï¼š`app/routers/config.py` â†’ `POST /api/config/test`
- **å‰ç«¯è°ƒç”¨**ï¼š`frontend/src/views/Settings/ConfigManagement.vue` â†’ `testLLMConfig()`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿé…ç½®æŒ‡å—](../user-guide/system-configuration.md)
- [LLMå‚å®¶é…ç½®](../user-guide/llm-provider-configuration.md)
- [ä»£ç†é…ç½®æŒ‡å—](./proxy-configuration.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-21

