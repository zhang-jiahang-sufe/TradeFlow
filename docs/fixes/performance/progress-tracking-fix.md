# ğŸ“Š è¿›åº¦è·Ÿè¸ªç³»ç»Ÿå®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

### 1. **æ ¸å¿ƒé—®é¢˜**
å‰ç«¯è¿›åº¦æ¡åœ¨åˆ†æè¿‡ç¨‹ä¸­ä¸èƒ½å®æ—¶æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯åœ¨"ç ”ç©¶è¾©è®º"é˜¶æ®µï¼ˆ60%-85%ï¼‰ä¼šå¡ä½ï¼Œç›´åˆ°åˆ†æå®Œæˆåç›´æ¥è·³åˆ°100%ã€‚

### 2. **æ ¹æœ¬åŸå› **

#### 2.1 èŠ‚ç‚¹åç§°ä¸åŒ¹é… âŒ
**é—®é¢˜**ï¼šLangGraph å®é™…ä½¿ç”¨çš„èŠ‚ç‚¹åç§°ä¸æˆ‘ä»¬çš„æ˜ å°„è¡¨ä¸åŒ¹é…

**LangGraph å®é™…èŠ‚ç‚¹åç§°**ï¼ˆæ¥è‡ª `tradingagents/graph/setup.py`ï¼‰ï¼š
```python
# åˆ†æå¸ˆèŠ‚ç‚¹
"Market Analyst"           # ä¸æ˜¯ 'market_analyst'
"Fundamentals Analyst"     # ä¸æ˜¯ 'fundamentals_analyst'
"News Analyst"             # ä¸æ˜¯ 'news_analyst'
"Social Analyst"           # ä¸æ˜¯ 'social_analyst'

# å·¥å…·èŠ‚ç‚¹
"tools_market"
"tools_fundamentals"
"tools_news"
"tools_social"

# æ¶ˆæ¯æ¸…ç†èŠ‚ç‚¹
"Msg Clear Market"
"Msg Clear Fundamentals"
"Msg Clear News"
"Msg Clear Social"

# ç ”ç©¶å‘˜èŠ‚ç‚¹
"Bull Researcher"          # ä¸æ˜¯ 'bull_researcher'
"Bear Researcher"          # ä¸æ˜¯ 'bear_researcher'
"Research Manager"         # ä¸æ˜¯ 'research_manager'

# äº¤æ˜“å‘˜èŠ‚ç‚¹
"Trader"                   # ä¸æ˜¯ 'trader'

# é£é™©è¯„ä¼°èŠ‚ç‚¹
"Risky Analyst"            # ä¸æ˜¯ 'risky_analyst'
"Safe Analyst"             # ä¸æ˜¯ 'safe_analyst'
"Neutral Analyst"          # ä¸æ˜¯ 'neutral_analyst'
"Risk Judge"               # ä¸æ˜¯ 'risk_manager'
```

**æˆ‘ä»¬ä¹‹å‰çš„é”™è¯¯æ˜ å°„**ï¼š
```python
node_mapping = {
    'market_analyst': "ğŸ“Š å¸‚åœºåˆ†æå¸ˆ",      # âŒ é”™è¯¯
    'fundamentals_analyst': "ğŸ’¼ åŸºæœ¬é¢åˆ†æå¸ˆ",  # âŒ é”™è¯¯
    'bull_researcher': "ğŸ‚ çœ‹æ¶¨ç ”ç©¶å‘˜",     # âŒ é”™è¯¯
    # ...
}
```

**ç»“æœ**ï¼šå›è°ƒå‡½æ•°æ— æ³•è¯†åˆ«ä»»ä½•èŠ‚ç‚¹ï¼Œå¯¼è‡´è¿›åº¦æ›´æ–°å®Œå…¨å¤±è´¥ã€‚

#### 2.2 è¿›åº¦è®¡ç®—ä¸å®Œæ•´ âŒ
**é—®é¢˜**ï¼šåªåœ¨"è¾©è®ºé˜¶æ®µ"æ›´æ–°è¿›åº¦ï¼Œå…¶ä»–é˜¶æ®µæ²¡æœ‰æ›´æ–°

**ä¹‹å‰çš„é€»è¾‘**ï¼š
```python
# åªå¤„ç†è¾©è®ºé˜¶æ®µï¼ˆ60%-85%ï¼‰
if "çœ‹æ¶¨" in message:
    debate_node_count = 1
elif "çœ‹è·Œ" in message:
    debate_node_count = 2
# ...
current_progress = 60 + (25 * progress_in_debate)
```

**ç¼ºå¤±çš„é˜¶æ®µ**ï¼š
- âŒ åˆ†æå¸ˆé˜¶æ®µï¼ˆ10%-45%ï¼‰ï¼šæ²¡æœ‰æ›´æ–°
- âŒ äº¤æ˜“å‘˜é˜¶æ®µï¼ˆ70%-78%ï¼‰ï¼šæ²¡æœ‰æ›´æ–°
- âŒ é£é™©è¯„ä¼°é˜¶æ®µï¼ˆ78%-93%ï¼‰ï¼šæ²¡æœ‰æ›´æ–°
- âŒ æœ€ç»ˆé˜¶æ®µï¼ˆ93%-100%ï¼‰ï¼šæ²¡æœ‰æ›´æ–°

#### 2.3 æ­¥éª¤æƒé‡ä¸å®é™…æ‰§è¡Œä¸åŒæ­¥ âŒ
**é—®é¢˜**ï¼š`RedisProgressTracker` å®šä¹‰çš„æ­¥éª¤æƒé‡ä¸ LangGraph å®é™…æ‰§è¡Œæµç¨‹ä¸åŒ¹é…

**æ­¥éª¤æƒé‡å®šä¹‰**ï¼ˆ`app/services/progress/tracker.py`ï¼‰ï¼š
```python
# 1) åŸºç¡€å‡†å¤‡é˜¶æ®µ (10%)
steps.extend([
    AnalysisStep("ğŸ“‹ å‡†å¤‡é˜¶æ®µ", ..., 0.03),
    AnalysisStep("ğŸ”§ ç¯å¢ƒæ£€æŸ¥", ..., 0.02),
    # ...
])

# 2) åˆ†æå¸ˆå›¢é˜Ÿé˜¶æ®µ (35%)
analyst_weight = 0.35 / max(len(self.analysts), 1)

# 3) ç ”ç©¶å›¢é˜Ÿè¾©è®ºé˜¶æ®µ (25%)
debate_weight = 0.25 / (3 + rounds)

# 4) äº¤æ˜“å›¢é˜Ÿé˜¶æ®µ (8%)
# 5) é£é™©ç®¡ç†å›¢é˜Ÿé˜¶æ®µ (15%)
# 6) æœ€ç»ˆå†³ç­–é˜¶æ®µ (7%)
```

**å®é™…æ‰§è¡Œæµç¨‹**ï¼š
- LangGraph åªæ‰§è¡Œåˆ†æå¸ˆã€ç ”ç©¶å‘˜ã€äº¤æ˜“å‘˜ã€é£é™©è¯„ä¼°ç­‰èŠ‚ç‚¹
- ä¸æ‰§è¡Œ"å‡†å¤‡é˜¶æ®µ"ã€"ç¯å¢ƒæ£€æŸ¥"ç­‰è™šæ‹Ÿæ­¥éª¤
- å¯¼è‡´æ­¥éª¤çŠ¶æ€ä¸å®é™…è¿›åº¦ä¸åŒæ­¥

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. **ä¿®å¤èŠ‚ç‚¹åç§°æ˜ å°„**

**æ–‡ä»¶**ï¼š`tradingagents/graph/trading_graph.py`

**ä¿®æ”¹**ï¼š`_send_progress_update()` æ–¹æ³•

```python
def _send_progress_update(self, chunk, progress_callback):
    """å‘é€è¿›åº¦æ›´æ–°åˆ°å›è°ƒå‡½æ•°
    
    LangGraph stream è¿”å›çš„ chunk æ ¼å¼ï¼š{node_name: {...}}
    """
    try:
        if not isinstance(chunk, dict):
            return
        
        # è·å–èŠ‚ç‚¹åç§°
        node_name = None
        for key in chunk.keys():
            if not key.startswith('__'):
                node_name = key
                break
        
        if not node_name:
            return
        
        # âœ… æ­£ç¡®çš„èŠ‚ç‚¹åç§°æ˜ å°„è¡¨
        node_mapping = {
            # åˆ†æå¸ˆèŠ‚ç‚¹ï¼ˆåŒ¹é… LangGraph å®é™…èŠ‚ç‚¹åï¼‰
            'Market Analyst': "ğŸ“Š å¸‚åœºåˆ†æå¸ˆ",
            'Fundamentals Analyst': "ğŸ’¼ åŸºæœ¬é¢åˆ†æå¸ˆ",
            'News Analyst': "ğŸ“° æ–°é—»åˆ†æå¸ˆ",
            'Social Analyst': "ğŸ’¬ ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ",
            # å·¥å…·èŠ‚ç‚¹ï¼ˆè·³è¿‡ï¼Œé¿å…é‡å¤ï¼‰
            'tools_market': None,
            'tools_fundamentals': None,
            'tools_news': None,
            'tools_social': None,
            # æ¶ˆæ¯æ¸…ç†èŠ‚ç‚¹ï¼ˆè·³è¿‡ï¼‰
            'Msg Clear Market': None,
            'Msg Clear Fundamentals': None,
            'Msg Clear News': None,
            'Msg Clear Social': None,
            # ç ”ç©¶å‘˜èŠ‚ç‚¹
            'Bull Researcher': "ğŸ‚ çœ‹æ¶¨ç ”ç©¶å‘˜",
            'Bear Researcher': "ğŸ» çœ‹è·Œç ”ç©¶å‘˜",
            'Research Manager': "ğŸ‘” ç ”ç©¶ç»ç†",
            # äº¤æ˜“å‘˜èŠ‚ç‚¹
            'Trader': "ğŸ’¼ äº¤æ˜“å‘˜å†³ç­–",
            # é£é™©è¯„ä¼°èŠ‚ç‚¹
            'Risky Analyst': "ğŸ”¥ æ¿€è¿›é£é™©è¯„ä¼°",
            'Safe Analyst': "ğŸ›¡ï¸ ä¿å®ˆé£é™©è¯„ä¼°",
            'Neutral Analyst': "âš–ï¸ ä¸­æ€§é£é™©è¯„ä¼°",
            'Risk Judge': "ğŸ¯ é£é™©ç»ç†",
        }
        
        message = node_mapping.get(node_name)
        
        if message is None:
            # è·³è¿‡å·¥å…·èŠ‚ç‚¹å’Œæ¶ˆæ¯æ¸…ç†èŠ‚ç‚¹
            return
        
        if message:
            # å‘é€è¿›åº¦æ›´æ–°
            progress_callback(message)
        else:
            # æœªçŸ¥èŠ‚ç‚¹
            progress_callback(f"ğŸ” {node_name}")
            
    except Exception as e:
        logger.error(f"âŒ è¿›åº¦æ›´æ–°å¤±è´¥: {e}", exc_info=True)
```

### 2. **ä¿®å¤è¿›åº¦è®¡ç®—é€»è¾‘**

**æ–‡ä»¶**ï¼š`app/services/simple_analysis_service.py`

**ä¿®æ”¹**ï¼š`graph_progress_callback()` å‡½æ•°

```python
# âœ… å®Œæ•´çš„èŠ‚ç‚¹è¿›åº¦æ˜ å°„è¡¨
node_progress_map = {
    # åˆ†æå¸ˆé˜¶æ®µ (10% â†’ 45%)
    "ğŸ“Š å¸‚åœºåˆ†æå¸ˆ": 27.5,      # 10% + 17.5%
    "ğŸ’¼ åŸºæœ¬é¢åˆ†æå¸ˆ": 45,       # 10% + 35%
    "ğŸ“° æ–°é—»åˆ†æå¸ˆ": 27.5,
    "ğŸ’¬ ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ": 27.5,
    # ç ”ç©¶è¾©è®ºé˜¶æ®µ (45% â†’ 70%)
    "ğŸ‚ çœ‹æ¶¨ç ”ç©¶å‘˜": 51.25,      # 45% + 6.25%
    "ğŸ» çœ‹è·Œç ”ç©¶å‘˜": 57.5,       # 45% + 12.5%
    "ğŸ‘” ç ”ç©¶ç»ç†": 70,           # 45% + 25%
    # äº¤æ˜“å‘˜é˜¶æ®µ (70% â†’ 78%)
    "ğŸ’¼ äº¤æ˜“å‘˜å†³ç­–": 78,         # 70% + 8%
    # é£é™©è¯„ä¼°é˜¶æ®µ (78% â†’ 93%)
    "ğŸ”¥ æ¿€è¿›é£é™©è¯„ä¼°": 81.75,    # 78% + 3.75%
    "ğŸ›¡ï¸ ä¿å®ˆé£é™©è¯„ä¼°": 85.5,    # 78% + 7.5%
    "âš–ï¸ ä¸­æ€§é£é™©è¯„ä¼°": 89.25,   # 78% + 11.25%
    "ğŸ¯ é£é™©ç»ç†": 93,           # 78% + 15%
    # æœ€ç»ˆé˜¶æ®µ (93% â†’ 100%)
    "ğŸ“Š ç”ŸæˆæŠ¥å‘Š": 97,           # 93% + 4%
}

def graph_progress_callback(message: str):
    """æ¥æ”¶ LangGraph çš„è¿›åº¦æ›´æ–°"""
    try:
        if not progress_tracker:
            return
        
        # âœ… ç›´æ¥æ˜ å°„èŠ‚ç‚¹åˆ°è¿›åº¦ç™¾åˆ†æ¯”
        progress_pct = node_progress_map.get(message)
        
        if progress_pct is not None:
            progress_tracker.update_progress({
                'progress_percentage': int(progress_pct),
                'last_message': message
            })
            logger.info(f"ğŸ“Š è¿›åº¦å·²æ›´æ–°: {int(progress_pct)}% - {message}")
        else:
            # æœªçŸ¥èŠ‚ç‚¹ï¼Œåªæ›´æ–°æ¶ˆæ¯
            progress_tracker.update_progress({
                'last_message': message
            })
            
    except Exception as e:
        logger.error(f"âŒ å›è°ƒå¤±è´¥: {e}", exc_info=True)
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ
```
è¿›åº¦: 10% â†’ 60% â†’ [å¡ä½å¾ˆä¹…] â†’ 100%
æ­¥éª¤: å‡†å¤‡é˜¶æ®µ â†’ åŸºæœ¬é¢åˆ†æå¸ˆ â†’ [å¡ä½] â†’ å®Œæˆ
```

### ä¿®å¤å âœ…
```
è¿›åº¦: 10% â†’ 27.5% â†’ 45% â†’ 51.25% â†’ 57.5% â†’ 70% â†’ 78% â†’ 81.75% â†’ 85.5% â†’ 89.25% â†’ 93% â†’ 97% â†’ 100%
æ­¥éª¤: å‡†å¤‡ â†’ å¸‚åœºåˆ†æå¸ˆ â†’ åŸºæœ¬é¢åˆ†æå¸ˆ â†’ çœ‹æ¶¨ç ”ç©¶å‘˜ â†’ çœ‹è·Œç ”ç©¶å‘˜ â†’ ç ”ç©¶ç»ç† â†’ äº¤æ˜“å‘˜ â†’ æ¿€è¿›é£é™© â†’ ä¿å®ˆé£é™© â†’ ä¸­æ€§é£é™© â†’ é£é™©ç»ç† â†’ ç”ŸæˆæŠ¥å‘Š â†’ å®Œæˆ
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **é‡å¯åç«¯**
   ```powershell
   .\.venv\Scripts\python -m app
   ```

2. **è§¦å‘æ–°çš„åˆ†æä»»åŠ¡**
   - åœ¨å‰ç«¯ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®
   - è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š601398ï¼‰

3. **è§‚å¯Ÿè¿›åº¦æ›´æ–°**
   - å‰ç«¯è¿›åº¦æ¡åº”è¯¥å¹³æ»‘æ›´æ–°
   - æ­¥éª¤çŠ¶æ€åº”è¯¥æ­£ç¡®æ˜¾ç¤ºï¼ˆcompleted/current/pendingï¼‰
   - å½“å‰æ­¥éª¤åç§°åº”è¯¥å®æ—¶æ›´æ–°

4. **æ£€æŸ¥æ—¥å¿—**
   ```powershell
   # æŸ¥çœ‹è¿›åº¦å›è°ƒæ—¥å¿—
   Get-Content "logs\webapi.log" -Tail 1000 | Select-String "ğŸ¯ğŸ¯ğŸ¯|ğŸ“Š \[Graphè¿›åº¦\]"
   ```

## ğŸ“ å…³é”®æ”¹è¿›ç‚¹

1. âœ… **èŠ‚ç‚¹åç§°å®Œå…¨åŒ¹é…**ï¼šä½¿ç”¨ LangGraph å®é™…çš„èŠ‚ç‚¹åç§°
2. âœ… **è¦†ç›–æ‰€æœ‰é˜¶æ®µ**ï¼šåˆ†æå¸ˆã€ç ”ç©¶å‘˜ã€äº¤æ˜“å‘˜ã€é£é™©è¯„ä¼°ã€æœ€ç»ˆé˜¶æ®µ
3. âœ… **è·³è¿‡ä¸­é—´èŠ‚ç‚¹**ï¼šå·¥å…·èŠ‚ç‚¹å’Œæ¶ˆæ¯æ¸…ç†èŠ‚ç‚¹ä¸è§¦å‘è¿›åº¦æ›´æ–°
4. âœ… **è¿›åº¦ç™¾åˆ†æ¯”å‡†ç¡®**ï¼šä¸ RedisProgressTracker çš„æ­¥éª¤æƒé‡å¯¹åº”
5. âœ… **é”™è¯¯å¤„ç†å®Œå–„**ï¼šæœªçŸ¥èŠ‚ç‚¹ä¹Ÿèƒ½æ­£å¸¸å¤„ç†

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

1. **åŠ¨æ€è®¡ç®—è¿›åº¦**ï¼šæ ¹æ®å®é™…é€‰æ‹©çš„åˆ†æå¸ˆæ•°é‡åŠ¨æ€è°ƒæ•´è¿›åº¦ç™¾åˆ†æ¯”
2. **è¾©è®ºè½®æ¬¡æ”¯æŒ**ï¼šæ ¹æ® research_depth åŠ¨æ€è®¡ç®—è¾©è®ºé˜¶æ®µçš„è¿›åº¦
3. **å¹¶è¡Œåˆ†æå¸ˆ**ï¼šå¦‚æœåˆ†æå¸ˆå¹¶è¡Œæ‰§è¡Œï¼Œéœ€è¦è°ƒæ•´è¿›åº¦è®¡ç®—é€»è¾‘
4. **è¿›åº¦å¹³æ»‘è¿‡æ¸¡**ï¼šæ·»åŠ è¿›åº¦åŠ¨ç”»ï¼Œé¿å…è·³è·ƒå¼æ›´æ–°

