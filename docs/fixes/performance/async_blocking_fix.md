# å¼‚æ­¥é˜»å¡é—®é¢˜ä¿®å¤æ–‡æ¡£

## ğŸ“‹ é—®é¢˜æè¿°

### ç°è±¡
åœ¨æ‰§è¡Œ `/api/sync/multi-source/test-sources` æ¥å£æ—¶ï¼Œå…¶ä»–APIæ¥å£ï¼ˆå¦‚ `/api/notifications/unread_count`ï¼‰ä¼šå‡ºç°è¶…æ—¶é”™è¯¯ï¼š

```
âŒ APIé”™è¯¯: undefined /api/notifications/unread_count 
{
  error: AxiosError, 
  message: 'timeout of 30000ms exceeded', 
  code: 'ECONNABORTED'
}
```

### è§¦å‘æ¡ä»¶
- **åªåœ¨æ•°æ®æºæµ‹è¯•æ—¶å‡ºç°**ï¼šæ‰§è¡Œ `POST /api/sync/multi-source/test-sources`
- **å…¶ä»–æ—¶å€™æ­£å¸¸**ï¼šå•ç‹¬è°ƒç”¨ `/api/notifications/unread_count` ä¸ä¼šè¶…æ—¶
- **ç­‰å¾…æœŸé—´è¶…æ—¶**ï¼šåœ¨æ•°æ®æºæµ‹è¯•å®Œæˆä¹‹å‰ï¼Œå…¶ä»–æ¥å£æ— æ³•å“åº”

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. äº‹ä»¶å¾ªç¯é˜»å¡

`/api/sync/multi-source/test-sources` æ¥å£è™½ç„¶å®šä¹‰ä¸º `async def`ï¼Œä½†å†…éƒ¨è°ƒç”¨çš„æ˜¯**åŒæ­¥æ–¹æ³•**ï¼š

```python
@router.post("/test-sources")
async def test_data_sources():
    for adapter in available_adapters:
        # âŒ è¿™æ˜¯åŒæ­¥è°ƒç”¨ï¼Œä¼šé˜»å¡äº‹ä»¶å¾ªç¯
        df = adapter.get_stock_list()  
        trade_date = adapter.find_latest_trade_date()
        df = adapter.get_daily_basic(trade_date)
```

### 2. è€—æ—¶æ“ä½œ

æ¯ä¸ªæ•°æ®æºçš„æµ‹è¯•éƒ½åŒ…å«ï¼š
- **è·å–è‚¡ç¥¨åˆ—è¡¨**ï¼š5000+ åªè‚¡ç¥¨ï¼Œéœ€è¦ 5-10 ç§’
- **æŸ¥æ‰¾æœ€æ–°äº¤æ˜“æ—¥æœŸ**ï¼šéœ€è¦ 1-2 ç§’
- **è·å–æ¯æ—¥åŸºç¡€æ•°æ®**ï¼š5000+ åªè‚¡ç¥¨ï¼Œéœ€è¦ 10-20 ç§’

**æ€»è€—æ—¶**ï¼š3ä¸ªæ•°æ®æº Ã— 20ç§’ = **60ç§’å·¦å³**

### 3. èµ„æºç«äº‰

åœ¨æµ‹è¯•æœŸé—´ï¼š
- **äº‹ä»¶å¾ªç¯è¢«é˜»å¡**ï¼šæ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚
- **MongoDBè¿æ¥è¢«å ç”¨**ï¼šæ•°æ®æºæµ‹è¯•å¯èƒ½è®¿é—®MongoDB
- **å…¶ä»–è¯·æ±‚æ’é˜Ÿç­‰å¾…**ï¼šè¶…è¿‡30ç§’å°±ä¼šè¶…æ—¶

### 4. æ¶æ„é—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI å¼‚æ­¥äº‹ä»¶å¾ªç¯                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ test-sources æ¥å£                â”‚    â”‚
â”‚  â”‚ âŒ åŒæ­¥è°ƒç”¨é˜»å¡äº‹ä»¶å¾ªç¯           â”‚    â”‚
â”‚  â”‚    adapter.get_stock_list()     â”‚    â”‚
â”‚  â”‚    (è€—æ—¶ 60 ç§’)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ notifications/unread_count      â”‚    â”‚
â”‚  â”‚ â±ï¸  ç­‰å¾…äº‹ä»¶å¾ªç¯...               â”‚    â”‚
â”‚  â”‚ â±ï¸  ç­‰å¾…äº‹ä»¶å¾ªç¯...               â”‚    â”‚
â”‚  â”‚ âŒ è¶…æ—¶ (30ç§’)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
å°†**åŒæ­¥çš„ã€è€—æ—¶çš„æ“ä½œ**æ”¾åˆ°**åå°çº¿ç¨‹**ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ã€‚

### å®ç°æ–¹å¼

#### 1. ä½¿ç”¨ `asyncio.to_thread()`

```python
# âŒ ä¿®å¤å‰ï¼šåŒæ­¥è°ƒç”¨é˜»å¡äº‹ä»¶å¾ªç¯
df = adapter.get_stock_list()

# âœ… ä¿®å¤åï¼šåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ
df = await asyncio.to_thread(adapter.get_stock_list)
```

#### 2. æå–æµ‹è¯•å‡½æ•°

```python
async def _test_single_adapter(adapter) -> dict:
    """
    åœ¨åå°çº¿ç¨‹ä¸­æµ‹è¯•å•ä¸ªæ•°æ®æºé€‚é…å™¨
    é¿å…é˜»å¡äº‹ä»¶å¾ªç¯
    """
    result = {
        "name": adapter.name,
        "priority": adapter.priority,
        "available": True,
        "tests": {}
    }
    
    # æµ‹è¯•è‚¡ç¥¨åˆ—è¡¨è·å–ï¼ˆåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰
    try:
        df = await asyncio.to_thread(adapter.get_stock_list)
        if df is not None and not df.empty:
            result["tests"]["stock_list"] = {
                "success": True,
                "count": len(df),
                "message": f"Successfully fetched {len(df)} stocks"
            }
    except Exception as e:
        result["tests"]["stock_list"] = {
            "success": False,
            "message": f"Error: {str(e)}"
        }
    
    # æµ‹è¯•æœ€æ–°äº¤æ˜“æ—¥æœŸï¼ˆåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰
    try:
        trade_date = await asyncio.to_thread(adapter.find_latest_trade_date)
        # ...
    except Exception as e:
        # ...
    
    # æµ‹è¯•æ¯æ—¥åŸºç¡€æ•°æ®ï¼ˆåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰
    try:
        trade_date = result["tests"]["trade_date"].get("date")
        if trade_date:
            df = await asyncio.to_thread(adapter.get_daily_basic, trade_date)
            # ...
    except Exception as e:
        # ...
    
    return result
```

#### 3. å¹¶å‘æµ‹è¯•æ‰€æœ‰é€‚é…å™¨

```python
@router.post("/test-sources")
async def test_data_sources():
    """
    æµ‹è¯•æ‰€æœ‰æ•°æ®æºçš„è¿æ¥å’Œæ•°æ®è·å–èƒ½åŠ›
    
    æ³¨æ„ï¼šæ­¤æ¥å£ä¼šæ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆè·å–è‚¡ç¥¨åˆ—è¡¨ç­‰ï¼‰ï¼Œ
    æ‰€æœ‰åŒæ­¥æ“ä½œéƒ½åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯
    """
    manager = DataSourceManager()
    available_adapters = manager.get_available_adapters()
    
    # å¹¶å‘æµ‹è¯•æ‰€æœ‰é€‚é…å™¨ï¼ˆåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰
    test_tasks = [_test_single_adapter(adapter) for adapter in available_adapters]
    test_results = await asyncio.gather(*test_tasks, return_exceptions=True)
    
    # å¤„ç†ç»“æœ...
    return SyncResponse(
        success=True,
        message=f"Tested {len(test_results)} data sources",
        data={"test_results": test_results}
    )
```

### ä¿®å¤åçš„æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI å¼‚æ­¥äº‹ä»¶å¾ªç¯                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ test-sources æ¥å£                â”‚    â”‚
â”‚  â”‚ âœ… å¼‚æ­¥è°ƒç”¨ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯       â”‚    â”‚
â”‚  â”‚    await asyncio.to_thread(...)  â”‚    â”‚
â”‚  â”‚    â†“                             â”‚    â”‚
â”‚  â”‚  [åå°çº¿ç¨‹æ± ]                    â”‚    â”‚
â”‚  â”‚    adapter.get_stock_list()     â”‚    â”‚
â”‚  â”‚    (è€—æ—¶ 60 ç§’)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ notifications/unread_count      â”‚    â”‚
â”‚  â”‚ âœ… ç«‹å³å“åº” (< 1ç§’)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ æ•°æ®æºæµ‹è¯•æœŸé—´ï¼Œå…¶ä»–æ¥å£è¶…æ—¶ï¼ˆ30ç§’ï¼‰
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼Œå‰ç«¯æŠ¥é”™
- âŒ äº‹ä»¶å¾ªç¯è¢«é˜»å¡

### ä¿®å¤å
- âœ… æ•°æ®æºæµ‹è¯•æœŸé—´ï¼Œå…¶ä»–æ¥å£æ­£å¸¸å“åº”ï¼ˆ< 1ç§’ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼Œå‰ç«¯ä¸æŠ¥é”™
- âœ… äº‹ä»¶å¾ªç¯ä¸è¢«é˜»å¡
- âœ… å¹¶å‘æµ‹è¯•æ‰€æœ‰æ•°æ®æºï¼Œé€Ÿåº¦æ›´å¿«

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
python scripts/test_concurrent_api.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. å¯åŠ¨æ•°æ®æºæµ‹è¯•
2. åœ¨æµ‹è¯•æœŸé—´æ¯ç§’å‘é€ä¸€æ¬¡é€šçŸ¥æ¥å£è¯·æ±‚
3. ç»Ÿè®¡æˆåŠŸç‡å’Œå“åº”æ—¶é—´

### 2. æ‰‹åŠ¨æµ‹è¯•

**ç»ˆç«¯1ï¼šå¯åŠ¨åç«¯**
```bash
cd d:\code\TradingAgents-CN
.\.venv\Scripts\python -m uvicorn app.main:app --reload
```

**ç»ˆç«¯2ï¼šæµ‹è¯•æ•°æ®æº**
```bash
curl -X POST http://localhost:8000/api/sync/multi-source/test-sources
```

**ç»ˆç«¯3ï¼šå¹¶å‘æµ‹è¯•é€šçŸ¥æ¥å£**
```bash
# åœ¨æ•°æ®æºæµ‹è¯•æœŸé—´ï¼Œæ¯ç§’å‘é€ä¸€æ¬¡è¯·æ±‚
for i in {1..10}; do
  curl -H "Authorization: Bearer YOUR_TOKEN" \
       http://localhost:8000/api/notifications/unread_count
  sleep 1
done
```

### 3. å‰ç«¯æµ‹è¯•

1. æ‰“å¼€å‰ç«¯é¡µé¢
2. ç‚¹å‡»"æ•°æ®æºæµ‹è¯•"æŒ‰é’®
3. è§‚å¯Ÿå³ä¸Šè§’çš„é€šçŸ¥å›¾æ ‡æ˜¯å¦æ­£å¸¸æ›´æ–°
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è¶…æ—¶é”™è¯¯

## ğŸ“ æœ€ä½³å®è·µ

### 1. è¯†åˆ«é˜»å¡æ“ä½œ

ä»¥ä¸‹æ“ä½œå¯èƒ½é˜»å¡äº‹ä»¶å¾ªç¯ï¼š
- âŒ åŒæ­¥çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆpymongoï¼‰
- âŒ åŒæ­¥çš„HTTPè¯·æ±‚ï¼ˆrequestsï¼‰
- âŒ åŒæ­¥çš„æ–‡ä»¶I/Oï¼ˆopen/read/writeï¼‰
- âŒ CPUå¯†é›†å‹è®¡ç®—ï¼ˆå¤§æ•°æ®å¤„ç†ï¼‰
- âŒ ç¬¬ä¸‰æ–¹åº“çš„åŒæ­¥æ–¹æ³•ï¼ˆtushare/akshare/baostockï¼‰

### 2. ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬

ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬ï¼š
- âœ… å¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢ï¼ˆmotorï¼‰
- âœ… å¼‚æ­¥HTTPè¯·æ±‚ï¼ˆaiohttp/httpxï¼‰
- âœ… å¼‚æ­¥æ–‡ä»¶I/Oï¼ˆaiofilesï¼‰

### 3. æ— æ³•é¿å…æ—¶ä½¿ç”¨çº¿ç¨‹æ± 

å¦‚æœå¿…é¡»ä½¿ç”¨åŒæ­¥æ–¹æ³•ï¼š
```python
# ä½¿ç”¨ asyncio.to_thread() åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ
result = await asyncio.to_thread(sync_function, arg1, arg2)
```

### 4. ç›‘æ§å’Œæ—¥å¿—

æ·»åŠ æ—¥å¿—è®°å½•è€—æ—¶æ“ä½œï¼š
```python
import time

start = time.time()
result = await asyncio.to_thread(expensive_operation)
elapsed = time.time() - start

if elapsed > 5:
    logger.warning(f"âš ï¸  è€—æ—¶æ“ä½œ: {elapsed:.2f}ç§’")
```

## ğŸ”® æœªæ¥æ”¹è¿›

### 1. å¼‚æ­¥æ•°æ®æºé€‚é…å™¨

å°†æ•°æ®æºé€‚é…å™¨æ”¹ä¸ºå¼‚æ­¥ç‰ˆæœ¬ï¼š
```python
class AsyncTushareAdapter:
    async def get_stock_list(self):
        # ä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯
        async with aiohttp.ClientSession() as session:
            # ...
```

### 2. ç¼“å­˜æœºåˆ¶

æ·»åŠ ç¼“å­˜å‡å°‘é‡å¤è¯·æ±‚ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_stock_list_cached():
    # ...
```

### 3. åå°ä»»åŠ¡é˜Ÿåˆ—

å¯¹äºéå¸¸è€—æ—¶çš„æ“ä½œï¼Œä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—ï¼š
```python
from app.worker import celery_app

@celery_app.task
def test_data_sources_task():
    # åœ¨åå°workerä¸­æ‰§è¡Œ
    # ...
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [FastAPI å¹¶å‘å’Œå¼‚æ­¥](https://fastapi.tiangolo.com/async/)
- [Python asyncio æ–‡æ¡£](https://docs.python.org/3/library/asyncio.html)
- [asyncio.to_thread() æ–‡æ¡£](https://docs.python.org/3/library/asyncio-task.html#asyncio.to_thread)

## âœ… æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸€ä¸ªå…¸å‹çš„**å¼‚æ­¥ç¼–ç¨‹é™·é˜±**ï¼š

1. **é—®é¢˜**ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­è°ƒç”¨åŒæ­¥çš„è€—æ—¶æ“ä½œï¼Œé˜»å¡äº‹ä»¶å¾ªç¯
2. **ç—‡çŠ¶**ï¼šå…¶ä»–APIæ¥å£è¶…æ—¶ï¼Œç”¨æˆ·ä½“éªŒå·®
3. **è§£å†³**ï¼šä½¿ç”¨ `asyncio.to_thread()` å°†åŒæ­¥æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹
4. **æ•ˆæœ**ï¼šäº‹ä»¶å¾ªç¯ä¸è¢«é˜»å¡ï¼Œæ‰€æœ‰æ¥å£æ­£å¸¸å“åº”

**å…³é”®æ•™è®­**ï¼š
- âš ï¸  `async def` ä¸ç­‰äº"ä¸ä¼šé˜»å¡"
- âš ï¸  åŒæ­¥è°ƒç”¨ä¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯
- âœ… ä½¿ç”¨ `asyncio.to_thread()` å¤„ç†åŒæ­¥æ“ä½œ
- âœ… ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬çš„åº“å’Œæ–¹æ³•

