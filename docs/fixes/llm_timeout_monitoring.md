# LLM è¶…æ—¶ç›‘æ§å’Œä¼˜åŒ–

## é—®é¢˜æè¿°

åœ¨4çº§æ·±åº¦åˆ†æä¸­ï¼ŒRisk Manager è°ƒç”¨ LLM æ—¶å‡ºç°è¶…æ—¶ï¼ˆRequest timed outï¼‰ï¼Œä»æ—¥å¿—çœ‹è€—æ—¶è¶…è¿‡6åˆ†é’Ÿã€‚

## åŸå› åˆ†æ

### 1. Prompt è¿‡å¤§

Risk Manager çš„ prompt åŒ…å«ï¼š
- å®Œæ•´çš„é£é™©è¾©è®ºå†å²ï¼ˆ3ä¸ªåˆ†æå¸ˆ Ã— 2è½® = 6æ¬¡å‘è¨€ï¼‰
- å¸‚åœºç ”ç©¶æŠ¥å‘Š
- æƒ…ç»ªåˆ†ææŠ¥å‘Š
- æ–°é—»æŠ¥å‘Š
- åŸºæœ¬é¢æŠ¥å‘Š
- äº¤æ˜“å‘˜è®¡åˆ’
- å†å²è®°å¿†

**ä¼°ç®—**ï¼š
- 2è½®é£é™©è®¨è®ºï¼šæ¯ä¸ªåˆ†æå¸ˆæ¯æ¬¡å‘è¨€ 500-1000 å­—ç¬¦ï¼Œ6æ¬¡å‘è¨€ = 3000-6000 å­—ç¬¦
- å„ç§æŠ¥å‘Šï¼š2000-4000 å­—ç¬¦
- **æ€»è®¡ï¼š5000-10000 å­—ç¬¦ â‰ˆ 3000-6000 tokens**

### 2. è¶…æ—¶é…ç½®ä¸è¶³

åŸå§‹é…ç½®ï¼š
- å›ºå®šè¶…æ—¶ï¼š120ç§’
- å®é™…éœ€è¦ï¼š300ç§’ä»¥ä¸Šï¼ˆæ ¹æ®æ—¥å¿—ï¼‰

## è§£å†³æ–¹æ¡ˆ

### 1. åŠ¨æ€è¶…æ—¶é…ç½®

**æ–‡ä»¶**: `tradingagents/graph/trading_graph.py`

æ ¹æ®ç ”ç©¶æ·±åº¦åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´ï¼š

```python
# è®¡ç®—åˆç†çš„è¶…æ—¶æ—¶é—´ï¼šåŸºç¡€300ç§’ + æ¯è½®è¾©è®ºé¢å¤–60ç§’
base_timeout = 300
debate_timeout = max_debate_rounds * 30  # æŠ•èµ„è¾©è®ºæ¯è½®30ç§’
risk_timeout = max_risk_discuss_rounds * 60  # é£é™©è®¨è®ºæ¯è½®60ç§’
total_timeout = base_timeout + debate_timeout + risk_timeout
```

**è¶…æ—¶æ—¶é—´å¯¹ç…§è¡¨**ï¼š

| ç ”ç©¶æ·±åº¦ | è¾©è®ºè½®æ¬¡ | é£é™©è½®æ¬¡ | è®¡ç®—å…¬å¼ | æ€»è¶…æ—¶ |
|---------|---------|---------|---------|--------|
| 1çº§-å¿«é€Ÿ | 1 | 1 | 300 + 1Ã—30 + 1Ã—60 | 390ç§’ |
| 2çº§-åŸºç¡€ | 1 | 1 | 300 + 1Ã—30 + 1Ã—60 | 390ç§’ |
| 3çº§-æ ‡å‡† | 1 | 2 | 300 + 1Ã—30 + 2Ã—60 | 450ç§’ |
| **4çº§-æ·±åº¦** | **2** | **2** | **300 + 2Ã—30 + 2Ã—60** | **480ç§’** |
| **5çº§-å…¨é¢** | **3** | **3** | **300 + 3Ã—30 + 3Ã—60** | **570ç§’** |

### 2. æ·»åŠ è¯¦ç»†ç›‘æ§

#### 2.1 Risk Manager ç›‘æ§

**æ–‡ä»¶**: `tradingagents/agents/managers/risk_manager.py`

**è¾“å…¥ç»Ÿè®¡**ï¼š
```python
logger.info(f"ğŸ“Š [Risk Manager] Prompt ç»Ÿè®¡:")
logger.info(f"   - è¾©è®ºå†å²é•¿åº¦: {len(history)} å­—ç¬¦")
logger.info(f"   - äº¤æ˜“å‘˜è®¡åˆ’é•¿åº¦: {len(trader_plan)} å­—ç¬¦")
logger.info(f"   - å†å²è®°å¿†é•¿åº¦: {len(past_memory_str)} å­—ç¬¦")
logger.info(f"   - æ€» Prompt é•¿åº¦: {prompt_length} å­—ç¬¦")
logger.info(f"   - ä¼°ç®—è¾“å…¥ Token: ~{estimated_tokens} tokens")
```

**è¾“å‡ºç»Ÿè®¡**ï¼š
```python
logger.info(f"â±ï¸ [Risk Manager] LLMè°ƒç”¨è€—æ—¶: {elapsed_time:.2f}ç§’")
logger.info(f"ğŸ“Š [Risk Manager] å“åº”ç»Ÿè®¡: {response_length} å­—ç¬¦, ä¼°ç®—~{estimated_output_tokens} tokens")
```

**Token ä½¿ç”¨æƒ…å†µ**ï¼ˆå¦‚æœ LLM è¿”å›ï¼‰ï¼š
```python
if hasattr(response, 'response_metadata') and 'token_usage' in response.response_metadata:
    token_usage = response.response_metadata['token_usage']
    logger.info(f"å®é™…Token: è¾“å…¥={token_usage['prompt_tokens']} è¾“å‡º={token_usage['completion_tokens']} æ€»è®¡={token_usage['total_tokens']}")
```

#### 2.2 Research Manager ç›‘æ§

**æ–‡ä»¶**: `tradingagents/agents/managers/research_manager.py`

ç±»ä¼¼çš„ç»Ÿè®¡ä¿¡æ¯ï¼š
- Prompt é•¿åº¦ç»Ÿè®¡
- ä¼°ç®— Token æ•°é‡
- LLM è°ƒç”¨è€—æ—¶
- å“åº”é•¿åº¦ç»Ÿè®¡

## å¦‚ä½•ä½¿ç”¨ç›‘æ§æ—¥å¿—

### 1. æŸ¥çœ‹è¶…æ—¶é…ç½®

```powershell
Get-Content logs/tradingagents.log | Select-String "é˜¿é‡Œç™¾ç‚¼.*è¶…æ—¶|ç ”ç©¶æ·±åº¦.*è¾©è®ºè½®æ¬¡"
```

æœŸæœ›çœ‹åˆ°ï¼š
```
â±ï¸ [é˜¿é‡Œç™¾ç‚¼] ç ”ç©¶æ·±åº¦: æ·±åº¦, è¾©è®ºè½®æ¬¡: 2, é£é™©è®¨è®ºè½®æ¬¡: 2
â±ï¸ [é˜¿é‡Œç™¾ç‚¼] è®¡ç®—è¶…æ—¶æ—¶é—´: 300s (åŸºç¡€) + 60s (è¾©è®º) + 120s (é£é™©) = 480s
âœ… [é˜¿é‡Œç™¾ç‚¼] å·²è®¾ç½®åŠ¨æ€è¯·æ±‚è¶…æ—¶: 480ç§’
```

### 2. æŸ¥çœ‹ Risk Manager æ€§èƒ½

```powershell
Get-Content logs/tradingagents.log | Select-String "Risk Manager.*Prompt ç»Ÿè®¡|Risk Manager.*è°ƒç”¨è€—æ—¶|Risk Manager.*å“åº”ç»Ÿè®¡"
```

æœŸæœ›çœ‹åˆ°ï¼š
```
ğŸ“Š [Risk Manager] Prompt ç»Ÿè®¡:
   - è¾©è®ºå†å²é•¿åº¦: 8523 å­—ç¬¦
   - äº¤æ˜“å‘˜è®¡åˆ’é•¿åº¦: 1245 å­—ç¬¦
   - å†å²è®°å¿†é•¿åº¦: 234 å­—ç¬¦
   - æ€» Prompt é•¿åº¦: 12456 å­—ç¬¦
   - ä¼°ç®—è¾“å…¥ Token: ~6920 tokens

â±ï¸ [Risk Manager] LLMè°ƒç”¨è€—æ—¶: 245.32ç§’
ğŸ“Š [Risk Manager] å“åº”ç»Ÿè®¡: 1523 å­—ç¬¦, ä¼°ç®—~846 tokens
```

### 3. æŸ¥çœ‹ Research Manager æ€§èƒ½

```powershell
Get-Content logs/tradingagents.log | Select-String "Research Manager.*Prompt ç»Ÿè®¡|Research Manager.*è°ƒç”¨è€—æ—¶"
```

## æ€§èƒ½åˆ†æ

### æ­£å¸¸æƒ…å†µ

**4çº§æ·±åº¦åˆ†æ**ï¼š
- Research Manager: 60-120ç§’
- Risk Manager: 120-300ç§’
- æ€»è€—æ—¶: 180-420ç§’ï¼ˆ3-7åˆ†é’Ÿï¼‰

**5çº§å…¨é¢åˆ†æ**ï¼š
- Research Manager: 90-180ç§’
- Risk Manager: 180-450ç§’
- æ€»è€—æ—¶: 270-630ç§’ï¼ˆ4.5-10.5åˆ†é’Ÿï¼‰

### å¼‚å¸¸æƒ…å†µ

å¦‚æœçœ‹åˆ°ä»¥ä¸‹æƒ…å†µï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼š

1. **è¶…æ—¶é”™è¯¯**ï¼š
   ```
   âŒ [Risk Manager] LLMè°ƒç”¨å¤±è´¥: Request timed out.
   ```
   - **åŸå› **: è¶…æ—¶æ—¶é—´ä¸è¶³æˆ– LLM æœåŠ¡å“åº”æ…¢
   - **è§£å†³**: å¢åŠ  `base_timeout` æˆ–æ£€æŸ¥ç½‘ç»œ

2. **Prompt è¿‡å¤§**ï¼š
   ```
   ğŸ“Š [Risk Manager] æ€» Prompt é•¿åº¦: 25000 å­—ç¬¦
   ğŸ“Š [Risk Manager] ä¼°ç®—è¾“å…¥ Token: ~13889 tokens
   ```
   - **åŸå› **: è¾©è®ºè½®æ¬¡è¿‡å¤šæˆ–æŠ¥å‘Šè¿‡é•¿
   - **è§£å†³**: è€ƒè™‘æˆªæ–­å†å²æˆ–æ‘˜è¦æŠ¥å‘Š

3. **å“åº”æ—¶é—´è¿‡é•¿**ï¼š
   ```
   â±ï¸ [Risk Manager] LLMè°ƒç”¨è€—æ—¶: 450.00ç§’
   ```
   - **åŸå› **: Token æ•°é‡å¤§æˆ– LLM æœåŠ¡è´Ÿè½½é«˜
   - **è§£å†³**: ä¼˜åŒ– prompt æˆ–å‡çº§ LLM æœåŠ¡

## ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆå·²å®æ–½ï¼‰

1. âœ… **åŠ¨æ€è¶…æ—¶é…ç½®**: æ ¹æ®ç ”ç©¶æ·±åº¦è‡ªåŠ¨è°ƒæ•´
2. âœ… **è¯¦ç»†ç›‘æ§æ—¥å¿—**: è¿½è¸ª Token ä½¿ç”¨å’Œè€—æ—¶

### ä¸­æœŸä¼˜åŒ–ï¼ˆå¾…å®æ–½ï¼‰

1. **Prompt ä¼˜åŒ–**:
   - æˆªæ–­è¿‡é•¿çš„è¾©è®ºå†å²ï¼ˆä¿ç•™æœ€è¿‘3000å­—ç¬¦ï¼‰
   - ä½¿ç”¨æ‘˜è¦è€Œéå®Œæ•´æŠ¥å‘Š
   - å‡å°‘å†å²è®°å¿†æ•°é‡ï¼ˆä»2æ¡å‡åˆ°1æ¡ï¼‰

2. **å¹¶è¡Œå¤„ç†**:
   - æŸäº›ç‹¬ç«‹çš„åˆ†æå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
   - å‡å°‘æ€»ä½“ç­‰å¾…æ—¶é—´

### é•¿æœŸä¼˜åŒ–ï¼ˆå¾…è¯„ä¼°ï¼‰

1. **æµå¼è¾“å‡º**:
   - ä½¿ç”¨ LLM çš„æµå¼ API
   - è¾¹ç”Ÿæˆè¾¹å¤„ç†ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´

2. **ç¼“å­˜æœºåˆ¶**:
   - ç¼“å­˜ç›¸ä¼¼çš„åˆ†æç»“æœ
   - é¿å…é‡å¤è®¡ç®—

3. **æ¨¡å‹é€‰æ‹©**:
   - å¯¹äºç®€å•ä»»åŠ¡ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
   - åªåœ¨å…³é”®å†³ç­–æ—¶ä½¿ç”¨æ·±åº¦æ¨¡å‹

## æµ‹è¯•éªŒè¯

### 1. è¿è¡Œ4çº§æ·±åº¦åˆ†æ

è§‚å¯Ÿæ—¥å¿—ä¸­çš„ï¼š
- âœ… è¶…æ—¶é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯480ç§’ï¼‰
- âœ… Prompt å¤§å°æ˜¯å¦åˆç†ï¼ˆ<15000å­—ç¬¦ï¼‰
- âœ… å®é™…è€—æ—¶æ˜¯å¦åœ¨é¢„æœŸèŒƒå›´å†…ï¼ˆ<480ç§’ï¼‰

### 2. è¿è¡Œ5çº§å…¨é¢åˆ†æ

è§‚å¯Ÿæ—¥å¿—ä¸­çš„ï¼š
- âœ… è¶…æ—¶é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯570ç§’ï¼‰
- âœ… Prompt å¤§å°ï¼ˆå¯èƒ½æ›´å¤§ï¼‰
- âœ… å®é™…è€—æ—¶æ˜¯å¦åœ¨é¢„æœŸèŒƒå›´å†…ï¼ˆ<570ç§’ï¼‰

## æ€»ç»“

é€šè¿‡åŠ¨æ€è¶…æ—¶é…ç½®å’Œè¯¦ç»†ç›‘æ§ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
1. âœ… é¿å…ä¸å¿…è¦çš„è¶…æ—¶é”™è¯¯
2. âœ… å‡†ç¡®è¿½è¸ª LLM æ€§èƒ½
3. âœ… è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
4. âœ… ä¸ºè¿›ä¸€æ­¥ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒ

ç°åœ¨é‡æ–°è¿è¡Œ4çº§æ·±åº¦åˆ†æï¼Œè§‚å¯Ÿæ–°çš„ç›‘æ§æ—¥å¿—ï¼

