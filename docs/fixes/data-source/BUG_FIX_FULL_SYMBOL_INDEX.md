# ä¿®å¤ full_symbol å”¯ä¸€ç´¢å¼•å†²çªé—®é¢˜

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨è¿è¡Œè‚¡ç¥¨åŸºç¡€ä¿¡æ¯åŒæ­¥ä»»åŠ¡æ—¶ï¼Œå‡ºç° MongoDB å”¯ä¸€ç´¢å¼•å†²çªé”™è¯¯ï¼š

```
ERROR | Bulk write error on batch 2: batch op errors occurred, full error: 
{'writeErrors': [{'index': 823, 'code': 11000, 'keyPattern': {'full_symbol': 1}, 
'keyValue': {'full_symbol': None}, 
'errmsg': 'E11000 duplicate key error collection: tradingagents.stock_basic_info 
index: full_symbol_1 dup key: { full_symbol: null }', ...}]}
```

### å—å½±å“çš„è‚¡ç¥¨

- **301563** (Näº‘æ±‰) - åˆ›ä¸šæ¿æ–°è‚¡ï¼Œä¸Šå¸‚æ—¥æœŸï¼š20250930
- **920080** (å¥¥ç¾æ£®) - åŒ—äº¤æ‰€ï¼Œä¸Šå¸‚æ—¥æœŸï¼š20251010

è¿™äº›éƒ½æ˜¯æ–°ä¸Šå¸‚çš„è‚¡ç¥¨ï¼Œæ•°æ®åŒæ­¥æ—¶ `full_symbol` å­—æ®µæ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### 1. ç´¢å¼•é…ç½®é—®é¢˜

MongoDB çš„ `stock_basic_info` é›†åˆæœ‰ä¸€ä¸ª `full_symbol` å­—æ®µçš„å”¯ä¸€ç´¢å¼•ï¼ˆæ¥è‡ªæ‰©å±•è„šæœ¬ `scripts/migration/extend_stock_collections.py`ï¼‰ï¼š

```python
await basic_collection.create_index("full_symbol", unique=True)
```

### 2. æ•°æ®åŒæ­¥é€»è¾‘ç¼ºé™·

`app/services/basics_sync_service.py` åœ¨æ„å»ºæ–‡æ¡£æ—¶**æ²¡æœ‰è®¾ç½® `full_symbol` å­—æ®µ**ï¼š

```python
doc = {
    "code": code,
    "name": name,
    "area": area,
    "industry": industry,
    "market": market,
    "list_date": list_date,
    "sse": sse,
    "sec": category,
    "source": "tushare",
    "updated_at": now_iso,
    # âŒ ç¼ºå°‘ full_symbol å­—æ®µ
}
```

### 3. å”¯ä¸€ç´¢å¼•å†²çª

- å¤šæ¡è®°å½•çš„ `full_symbol` å­—æ®µéƒ½æ˜¯ `null`
- MongoDB å”¯ä¸€ç´¢å¼•ä¸å…è®¸å¤šä¸ª `null` å€¼
- å¯¼è‡´æ•°æ®åŒæ­¥æ—¶å‡ºç° `E11000 duplicate key error`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

1. **åˆ é™¤ full_symbol å”¯ä¸€ç´¢å¼•**ï¼ˆè§£å†³å½“å‰é—®é¢˜ï¼‰
2. **ä¸ºæ‰€æœ‰è®°å½•ç”Ÿæˆ full_symbol å­—æ®µ**ï¼ˆæ•°æ®ä¿®å¤ï¼‰
3. **æ›´æ–°æ•°æ®åŒæ­¥é€»è¾‘**ï¼ˆé˜²æ­¢æœªæ¥é—®é¢˜ï¼‰
4. **ï¼ˆå¯é€‰ï¼‰é‡æ–°åˆ›å»ºå”¯ä¸€ç´¢å¼•**ï¼ˆç­‰å¾…ä»£ç ç¨³å®šåï¼‰

---

## ğŸ› ï¸ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šè¿è¡Œä¿®å¤è„šæœ¬

**è„šæœ¬è·¯å¾„**ï¼š`scripts/fix_full_symbol_index.py`

**åŠŸèƒ½**ï¼š
1. åˆ é™¤ `full_symbol` å”¯ä¸€ç´¢å¼•
2. ä¸ºæ‰€æœ‰è®°å½•ç”Ÿæˆ `full_symbol` å­—æ®µ
3. éªŒè¯ä¿®å¤ç»“æœ

**è¿è¡Œå‘½ä»¤**ï¼š
```bash
python scripts/fix_full_symbol_index.py
```

**æ‰§è¡Œç»“æœ**ï¼š
```
================================================================================
ä¿®å¤ stock_basic_info é›†åˆçš„ full_symbol å”¯ä¸€ç´¢å¼•é—®é¢˜
================================================================================

ğŸ“Š [æ­¥éª¤1] æ£€æŸ¥ç°æœ‰ç´¢å¼•
--------------------------------------------------------------------------------
âœ… æ‰¾åˆ° full_symbol ç´¢å¼•: full_symbol_1 (unique=True)

ğŸ“Š [æ­¥éª¤2] åˆ é™¤ full_symbol å”¯ä¸€ç´¢å¼•
--------------------------------------------------------------------------------
âœ… æˆåŠŸåˆ é™¤ç´¢å¼•: full_symbol_1

ğŸ“Š [æ­¥éª¤3] ç»Ÿè®¡éœ€è¦æ›´æ–°çš„è®°å½•
--------------------------------------------------------------------------------
æ€»è®°å½•æ•°: 5437
full_symbol ä¸º null çš„è®°å½•: 1
full_symbol ä¸å­˜åœ¨çš„è®°å½•: 1
éœ€è¦æ›´æ–°çš„è®°å½•: 2

ğŸ“Š [æ­¥éª¤4] ä¸ºæ‰€æœ‰è®°å½•ç”Ÿæˆ full_symbol
--------------------------------------------------------------------------------
âœ… æ›´æ–°å®Œæˆ:
  æˆåŠŸ: 1 æ¡
  å¤±è´¥: 0 æ¡

ğŸ“Š [æ­¥éª¤5] éªŒè¯ç»“æœ
--------------------------------------------------------------------------------
âœ… æ‰€æœ‰è®°å½•çš„ full_symbol å­—æ®µéƒ½å·²æ­£ç¡®è®¾ç½®
```

### æ­¥éª¤ 2ï¼šæ›´æ–°æ•°æ®åŒæ­¥é€»è¾‘

**æ–‡ä»¶**ï¼š`app/services/basics_sync_service.py`

**æ”¹åŠ¨ 1**ï¼šæ·»åŠ  `_generate_full_symbol()` æ–¹æ³•

```python
def _generate_full_symbol(self, code: str) -> str:
    """
    æ ¹æ®è‚¡ç¥¨ä»£ç ç”Ÿæˆå®Œæ•´æ ‡å‡†åŒ–ä»£ç 
    
    Args:
        code: 6ä½è‚¡ç¥¨ä»£ç 
        
    Returns:
        å®Œæ•´æ ‡å‡†åŒ–ä»£ç ï¼ˆå¦‚ 000001.SZï¼‰
    """
    if not code or len(code) != 6:
        return None
    
    # æ ¹æ®ä»£ç åˆ¤æ–­äº¤æ˜“æ‰€
    if code.startswith(('60', '68', '90')):
        return f"{code}.SS"  # ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€
    elif code.startswith(('00', '30', '20')):
        return f"{code}.SZ"  # æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€
    elif code.startswith('8') or code.startswith('4'):
        return f"{code}.BJ"  # åŒ—äº¬è¯åˆ¸äº¤æ˜“æ‰€
    else:
        return f"{code}.SZ"  # é»˜è®¤æ·±åœ³
```

**æ”¹åŠ¨ 2**ï¼šåœ¨æ„å»ºæ–‡æ¡£æ—¶ç”Ÿæˆ `full_symbol`

```python
# ç”Ÿæˆ full_symbolï¼ˆå®Œæ•´æ ‡å‡†åŒ–ä»£ç ï¼‰
full_symbol = self._generate_full_symbol(code)

doc = {
    "code": code,
    "name": name,
    "area": area,
    "industry": industry,
    "market": market,
    "list_date": list_date,
    "sse": sse,
    "sec": category,
    "source": "tushare",
    "updated_at": now_iso,
    "full_symbol": full_symbol,  # âœ… æ·»åŠ å®Œæ•´æ ‡å‡†åŒ–ä»£ç 
}
```

---

## ğŸ“Š full_symbol ç”Ÿæˆè§„åˆ™

| ä»£ç å‰ç¼€ | äº¤æ˜“æ‰€ | full_symbol æ ¼å¼ | ç¤ºä¾‹ |
|---------|--------|-----------------|------|
| 60, 68, 90 | ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€ | `{code}.SS` | 600000.SS |
| 00, 30, 20 | æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€ | `{code}.SZ` | 000001.SZ |
| 8, 4 | åŒ—äº¬è¯åˆ¸äº¤æ˜“æ‰€ | `{code}.BJ` | 830799.BJ |
| å…¶ä»– | é»˜è®¤æ·±åœ³ | `{code}.SZ` | - |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. éªŒè¯ç°æœ‰æ•°æ®

```bash
# è¿æ¥ MongoDB
mongo tradingagents

# æ£€æŸ¥ full_symbol å­—æ®µ
db.stock_basic_info.find({"full_symbol": null}).count()  # åº”è¯¥ä¸º 0
db.stock_basic_info.find({"full_symbol": {$exists: false}}).count()  # åº”è¯¥ä¸º 0

# æŸ¥çœ‹ç¤ºä¾‹æ•°æ®
db.stock_basic_info.find({}, {code: 1, full_symbol: 1}).limit(10)
```

### 2. æµ‹è¯•æ•°æ®åŒæ­¥

```bash
# è¿è¡Œè‚¡ç¥¨åŸºç¡€ä¿¡æ¯åŒæ­¥
curl -X POST http://localhost:8000/api/admin/sync/stock-basics \
  -H "Authorization: Bearer <token>"

# æ£€æŸ¥æ—¥å¿—
tail -f logs/tradingagents.log | grep "full_symbol"
```

### 3. éªŒè¯æ–°è‚¡ç¥¨

```bash
# æŸ¥è¯¢æ–°ä¸Šå¸‚çš„è‚¡ç¥¨
db.stock_basic_info.find({code: "301563"}, {code: 1, name: 1, full_symbol: 1})
db.stock_basic_info.find({code: "920080"}, {code: 1, name: 1, full_symbol: 1})
```

**é¢„æœŸç»“æœ**ï¼š
```javascript
{ "code": "301563", "name": "Näº‘æ±‰", "full_symbol": "301563.SZ" }
{ "code": "920080", "name": "å¥¥ç¾æ£®", "full_symbol": "920080.BJ" }
```

---

## ğŸ“ æäº¤è®°å½•

### Commit 1: ä¿®å¤è„šæœ¬

**Message**: `fix: æ·»åŠ  full_symbol å”¯ä¸€ç´¢å¼•å†²çªä¿®å¤è„šæœ¬`

**æ–‡ä»¶**ï¼š
- `scripts/fix_full_symbol_index.py`ï¼ˆæ–°å¢ï¼‰

### Commit 2: ä»£ç ä¿®å¤

**Message**: `fix: ä¿®å¤ basics_sync_service ç¼ºå°‘ full_symbol å­—æ®µç”Ÿæˆé€»è¾‘`

**æ–‡ä»¶**ï¼š
- `app/services/basics_sync_service.py`ï¼ˆä¿®æ”¹ï¼‰

### Commit 3: æ–‡æ¡£

**Message**: `docs: æ·»åŠ  full_symbol å”¯ä¸€ç´¢å¼•å†²çªé—®é¢˜ä¿®å¤æ–‡æ¡£`

**æ–‡ä»¶**ï¼š
- `docs/BUG_FIX_FULL_SYMBOL_INDEX.md`ï¼ˆæ–°å¢ï¼‰

---

## ğŸ’¡ ç»éªŒæ•™è®­

### 1. ç´¢å¼•è®¾è®¡åŸåˆ™

- **å”¯ä¸€ç´¢å¼•**ï¼šåªå¯¹çœŸæ­£éœ€è¦å”¯ä¸€æ€§çº¦æŸçš„å­—æ®µåˆ›å»º
- **å¯ç©ºå­—æ®µ**ï¼šå¦‚æœå­—æ®µå¯èƒ½ä¸º `null`ï¼Œä¸è¦åˆ›å»ºå”¯ä¸€ç´¢å¼•
- **æ‰©å±•å­—æ®µ**ï¼šæ–°å¢å­—æ®µæ—¶è¦è€ƒè™‘ç°æœ‰æ•°æ®çš„å…¼å®¹æ€§

### 2. æ•°æ®åŒæ­¥åŸåˆ™

- **å­—æ®µå®Œæ•´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½è¢«æ­£ç¡®è®¾ç½®
- **ç´¢å¼•ä¸€è‡´æ€§**ï¼šæ•°æ®åŒæ­¥é€»è¾‘è¦ä¸ç´¢å¼•é…ç½®ä¿æŒä¸€è‡´
- **é™çº§æœºåˆ¶**ï¼šå­—æ®µç”Ÿæˆå¤±è´¥æ—¶è¦æœ‰åˆç†çš„é»˜è®¤å€¼

### 3. è¿ç§»è„šæœ¬åŸåˆ™

- **å‘åå…¼å®¹**ï¼šæ–°å¢ç´¢å¼•å‰è¦ç¡®ä¿ç°æœ‰æ•°æ®ç¬¦åˆçº¦æŸ
- **æ•°æ®ä¿®å¤**ï¼šå…ˆä¿®å¤æ•°æ®ï¼Œå†åˆ›å»ºç´¢å¼•
- **åˆ†æ­¥æ‰§è¡Œ**ï¼šå¤æ‚è¿ç§»è¦åˆ†æ­¥éª¤æ‰§è¡Œï¼Œä¾¿äºå›æ»š

---

## ğŸš€ åç»­ä¼˜åŒ–

### 1. çŸ­æœŸä¼˜åŒ–

- âœ… åˆ é™¤ `full_symbol` å”¯ä¸€ç´¢å¼•
- âœ… ä¸ºæ‰€æœ‰è®°å½•ç”Ÿæˆ `full_symbol` å­—æ®µ
- âœ… æ›´æ–° `basics_sync_service.py` æ·»åŠ  `full_symbol` ç”Ÿæˆé€»è¾‘
- â¬œ æµ‹è¯•æ•°æ®åŒæ­¥åŠŸèƒ½
- â¬œ ç›‘æ§æ—¥å¿—ç¡®è®¤æ— é”™è¯¯

### 2. ä¸­æœŸä¼˜åŒ–

- â¬œ æ›´æ–°å…¶ä»–æ•°æ®åŒæ­¥æœåŠ¡ï¼ˆ`multi_source_basics_sync_service.py`ï¼‰
- â¬œ ç»Ÿä¸€ `full_symbol` ç”Ÿæˆé€»è¾‘ï¼ˆæå–ä¸ºå·¥å…·å‡½æ•°ï¼‰
- â¬œ æ·»åŠ å•å…ƒæµ‹è¯•

### 3. é•¿æœŸä¼˜åŒ–

- â¬œ è¯„ä¼°æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»º `full_symbol` å”¯ä¸€ç´¢å¼•
- â¬œ å®Œå–„æ•°æ®æ¨¡å‹è®¾è®¡æ–‡æ¡£
- â¬œ å®æ–½æ•°æ®è´¨é‡ç›‘æ§

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è‚¡ç¥¨æ•°æ®æ¨¡å‹è®¾è®¡](./design/stock_data_model_design.md)
- [è‚¡ç¥¨åŸºç¡€ä¿¡æ¯åŒæ­¥æŒ‡å—](./guides/stock_basics_sync.md)
- [MongoDB ç´¢å¼•è®¾è®¡](./guides/mongodb_index_design.md)

