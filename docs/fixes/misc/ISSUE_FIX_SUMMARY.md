# é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“… æ—¥æœŸ
2025-10-16

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·æŠ¥å‘Š
> "æ•°æ®æºæµ‹è¯•çš„æ—¶å€™ï¼Œç»å¸¸è¿™ä¸ªæ¥å£æŠ¥é”™ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› å‘¢ã€‚âŒ APIé”™è¯¯: undefined /api/notifications/unread_count {error: AxiosError, message: 'timeout of 30000ms exceeded', code: 'ECONNABORTED', response: undefined, request: XMLHttpRequest, â€¦}"

### å…³é”®ä¿¡æ¯
- **è§¦å‘æ¡ä»¶**ï¼šåªåœ¨æ‰§è¡Œ `POST /api/sync/multi-source/test-sources` æ—¶å‡ºç°
- **è¶…æ—¶æ¥å£**ï¼š`/api/notifications/unread_count`
- **è¶…æ—¶æ—¶é—´**ï¼š30ç§’
- **å…¶ä»–æ—¶å€™**ï¼šå•ç‹¬è°ƒç”¨é€šçŸ¥æ¥å£æ­£å¸¸ï¼Œä¸ä¼šè¶…æ—¶

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ ¹æœ¬åŸå› 

**äº‹ä»¶å¾ªç¯é˜»å¡**ï¼š`/api/sync/multi-source/test-sources` æ¥å£è™½ç„¶å®šä¹‰ä¸º `async def`ï¼Œä½†å†…éƒ¨è°ƒç”¨çš„æ˜¯**åŒæ­¥æ–¹æ³•**ï¼Œå¯¼è‡´ FastAPI çš„äº‹ä»¶å¾ªç¯è¢«é˜»å¡ã€‚

```python
# âŒ é—®é¢˜ä»£ç 
@router.post("/test-sources")
async def test_data_sources():
    for adapter in available_adapters:
        # åŒæ­¥è°ƒç”¨ï¼Œé˜»å¡äº‹ä»¶å¾ªç¯ 60 ç§’
        df = adapter.get_stock_list()  # 5-10ç§’
        trade_date = adapter.find_latest_trade_date()  # 1-2ç§’
        df = adapter.get_daily_basic(trade_date)  # 10-20ç§’
```

### 2. ä¸ºä»€ä¹ˆä¼šè¶…æ—¶

```
æ—¶é—´çº¿ï¼š
0ç§’  â”€â†’ ç”¨æˆ·ç‚¹å‡»"æ•°æ®æºæµ‹è¯•"
1ç§’  â”€â†’ test-sources å¼€å§‹æ‰§è¡Œï¼ˆé˜»å¡äº‹ä»¶å¾ªç¯ï¼‰
2ç§’  â”€â†’ å‰ç«¯å®šæ—¶è¯·æ±‚ /api/notifications/unread_count
3ç§’  â”€â†’ é€šçŸ¥æ¥å£è¯·æ±‚æ’é˜Ÿç­‰å¾…...
...
30ç§’ â”€â†’ é€šçŸ¥æ¥å£è¯·æ±‚è¶…æ—¶ âŒ
...
60ç§’ â”€â†’ test-sources å®Œæˆ
```

### 3. æ¶æ„é—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI å¼‚æ­¥äº‹ä»¶å¾ªç¯ (å•çº¿ç¨‹)           â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ test-sources æ¥å£                â”‚    â”‚
â”‚  â”‚ âŒ åŒæ­¥è°ƒç”¨é˜»å¡äº‹ä»¶å¾ªç¯           â”‚    â”‚
â”‚  â”‚    adapter.get_stock_list()     â”‚    â”‚
â”‚  â”‚    (è€—æ—¶ 60 ç§’)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“ é˜»å¡                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ notifications/unread_count      â”‚    â”‚
â”‚  â”‚ â±ï¸  ç­‰å¾…äº‹ä»¶å¾ªç¯...               â”‚    â”‚
â”‚  â”‚ â±ï¸  ç­‰å¾…äº‹ä»¶å¾ªç¯...               â”‚    â”‚
â”‚  â”‚ âŒ è¶…æ—¶ (30ç§’)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
å°†**åŒæ­¥çš„ã€è€—æ—¶çš„æ“ä½œ**æ”¾åˆ°**åå°çº¿ç¨‹**ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ã€‚

### å®ç°æ­¥éª¤

#### 1. å¯¼å…¥ asyncio
```python
import asyncio
```

#### 2. æå–æµ‹è¯•å‡½æ•°
```python
async def _test_single_adapter(adapter) -> dict:
    """
    åœ¨åå°çº¿ç¨‹ä¸­æµ‹è¯•å•ä¸ªæ•°æ®æºé€‚é…å™¨
    é¿å…é˜»å¡äº‹ä»¶å¾ªç¯
    """
    result = {
        "name": adapter.name,
        "priority": adapter.priority,
        "available": True,
        "tests": {}
    }
    
    # âœ… åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡ŒåŒæ­¥æ–¹æ³•
    try:
        df = await asyncio.to_thread(adapter.get_stock_list)
        # ...
    except Exception as e:
        # ...
    
    try:
        trade_date = await asyncio.to_thread(adapter.find_latest_trade_date)
        # ...
    except Exception as e:
        # ...
    
    try:
        if trade_date:
            df = await asyncio.to_thread(adapter.get_daily_basic, trade_date)
            # ...
    except Exception as e:
        # ...
    
    return result
```

#### 3. å¹¶å‘æµ‹è¯•æ‰€æœ‰é€‚é…å™¨
```python
@router.post("/test-sources")
async def test_data_sources():
    """
    æµ‹è¯•æ‰€æœ‰æ•°æ®æºçš„è¿æ¥å’Œæ•°æ®è·å–èƒ½åŠ›
    
    æ³¨æ„ï¼šæ­¤æ¥å£ä¼šæ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆè·å–è‚¡ç¥¨åˆ—è¡¨ç­‰ï¼‰ï¼Œ
    æ‰€æœ‰åŒæ­¥æ“ä½œéƒ½åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯
    """
    manager = DataSourceManager()
    available_adapters = manager.get_available_adapters()
    
    logger.info(f"ğŸ§ª å¼€å§‹æµ‹è¯• {len(available_adapters)} ä¸ªæ•°æ®æº...")
    
    # âœ… å¹¶å‘æµ‹è¯•æ‰€æœ‰é€‚é…å™¨ï¼ˆåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰
    test_tasks = [_test_single_adapter(adapter) for adapter in available_adapters]
    test_results = await asyncio.gather(*test_tasks, return_exceptions=True)
    
    # å¤„ç†å¼‚å¸¸ç»“æœ
    final_results = []
    for i, result in enumerate(test_results):
        if isinstance(result, Exception):
            logger.error(f"âŒ æµ‹è¯•é€‚é…å™¨ {available_adapters[i].name} æ—¶å‡ºé”™: {result}")
            final_results.append({
                "name": available_adapters[i].name,
                "priority": available_adapters[i].priority,
                "available": False,
                "tests": {
                    "error": {
                        "success": False,
                        "message": f"Test failed: {str(result)}"
                    }
                }
            })
        else:
            final_results.append(result)
    
    logger.info(f"âœ… æ•°æ®æºæµ‹è¯•å®Œæˆï¼Œå…±æµ‹è¯• {len(final_results)} ä¸ªæ•°æ®æº")
    
    return SyncResponse(
        success=True,
        message=f"Tested {len(final_results)} data sources",
        data={"test_results": final_results}
    )
```

### ä¿®å¤åçš„æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI å¼‚æ­¥äº‹ä»¶å¾ªç¯                    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ test-sources æ¥å£                â”‚    â”‚
â”‚  â”‚ âœ… å¼‚æ­¥è°ƒç”¨ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯       â”‚    â”‚
â”‚  â”‚    await asyncio.to_thread(...)  â”‚    â”‚
â”‚  â”‚    â†“                             â”‚    â”‚
â”‚  â”‚  [åå°çº¿ç¨‹æ± ]                    â”‚    â”‚
â”‚  â”‚    adapter.get_stock_list()     â”‚    â”‚
â”‚  â”‚    (è€—æ—¶ 60 ç§’)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“ ä¸é˜»å¡                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ notifications/unread_count      â”‚    â”‚
â”‚  â”‚ âœ… ç«‹å³å“åº” (< 1ç§’)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ•°æ®æºæµ‹è¯•è€—æ—¶ | 60ç§’ |
| é€šçŸ¥æ¥å£å“åº”æ—¶é—´ | è¶…æ—¶ï¼ˆ30ç§’ï¼‰ |
| äº‹ä»¶å¾ªç¯çŠ¶æ€ | âŒ é˜»å¡ |
| ç”¨æˆ·ä½“éªŒ | âŒ å·® |

### ä¿®å¤å
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ•°æ®æºæµ‹è¯•è€—æ—¶ | 60ç§’ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰ |
| é€šçŸ¥æ¥å£å“åº”æ—¶é—´ | âœ… < 1ç§’ |
| äº‹ä»¶å¾ªç¯çŠ¶æ€ | âœ… æ­£å¸¸ |
| ç”¨æˆ·ä½“éªŒ | âœ… å¥½ |

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
python scripts/test_concurrent_api.py
```

### 2. é¢„æœŸç»“æœ
```
ğŸš€ å¹¶å‘APIæµ‹è¯•
â° å¼€å§‹æ—¶é—´: 14:30:00

ğŸ“Š å¯åŠ¨æ•°æ®æºæµ‹è¯•...
ğŸ“¬ å¼€å§‹å¹¶å‘æµ‹è¯•é€šçŸ¥æ¥å£ï¼ˆæ¯ç§’1æ¬¡ï¼‰...

  [ 1] âœ… é€šçŸ¥æ¥å£å“åº”æˆåŠŸ (0.15ç§’): {'success': True, 'data': {'count': 0}}
  [ 2] âœ… é€šçŸ¥æ¥å£å“åº”æˆåŠŸ (0.12ç§’): {'success': True, 'data': {'count': 0}}
  [ 3] âœ… é€šçŸ¥æ¥å£å“åº”æˆåŠŸ (0.14ç§’): {'success': True, 'data': {'count': 0}}
  ...
  [10] âœ… é€šçŸ¥æ¥å£å“åº”æˆåŠŸ (0.13ç§’): {'success': True, 'data': {'count': 0}}

ğŸ§ª æ•°æ®æºæµ‹è¯•å®Œæˆ (58.32ç§’)
   ğŸ“¡ tushare: âœ… 5438 åªè‚¡ç¥¨
   ğŸ“¡ akshare: âœ… 5437 åªè‚¡ç¥¨
   ğŸ“¡ baostock: âœ… 5473 åªè‚¡ç¥¨

ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»
â° ç»“æŸæ—¶é—´: 14:31:00

ğŸ§ª æ•°æ®æºæµ‹è¯•: âœ… æˆåŠŸ
ğŸ“¬ é€šçŸ¥æ¥å£æµ‹è¯•: 10/10 æˆåŠŸ

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®æºæµ‹è¯•æœŸé—´é€šçŸ¥æ¥å£æ²¡æœ‰è¶…æ—¶ã€‚
```

## ğŸ“ å…³é”®æ•™è®­

### 1. async def â‰  ä¸ä¼šé˜»å¡
```python
# âŒ é”™è¯¯ç†è§£
async def my_function():
    result = sync_blocking_call()  # ä»ç„¶ä¼šé˜»å¡ï¼
    return result

# âœ… æ­£ç¡®åšæ³•
async def my_function():
    result = await asyncio.to_thread(sync_blocking_call)
    return result
```

### 2. è¯†åˆ«é˜»å¡æ“ä½œ
ä»¥ä¸‹æ“ä½œå¯èƒ½é˜»å¡äº‹ä»¶å¾ªç¯ï¼š
- âŒ åŒæ­¥çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆpymongoï¼‰
- âŒ åŒæ­¥çš„HTTPè¯·æ±‚ï¼ˆrequestsï¼‰
- âŒ åŒæ­¥çš„æ–‡ä»¶I/Oï¼ˆopen/read/writeï¼‰
- âŒ CPUå¯†é›†å‹è®¡ç®—ï¼ˆå¤§æ•°æ®å¤„ç†ï¼‰
- âŒ ç¬¬ä¸‰æ–¹åº“çš„åŒæ­¥æ–¹æ³•ï¼ˆtushare/akshare/baostockï¼‰

### 3. ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬
- âœ… å¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢ï¼ˆmotorï¼‰
- âœ… å¼‚æ­¥HTTPè¯·æ±‚ï¼ˆaiohttp/httpxï¼‰
- âœ… å¼‚æ­¥æ–‡ä»¶I/Oï¼ˆaiofilesï¼‰

### 4. æ— æ³•é¿å…æ—¶ä½¿ç”¨çº¿ç¨‹æ± 
```python
# ä½¿ç”¨ asyncio.to_thread() åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ
result = await asyncio.to_thread(sync_function, arg1, arg2)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼‚æ­¥é˜»å¡é—®é¢˜ä¿®å¤è¯¦ç»†æ–‡æ¡£](./async_blocking_fix.md)
- [FastAPI å¹¶å‘å’Œå¼‚æ­¥](https://fastapi.tiangolo.com/async/)
- [Python asyncio æ–‡æ¡£](https://docs.python.org/3/library/asyncio.html)

## ğŸ”® æœªæ¥æ”¹è¿›

### 1. å¼‚æ­¥æ•°æ®æºé€‚é…å™¨
å°†æ•°æ®æºé€‚é…å™¨æ”¹ä¸ºå¼‚æ­¥ç‰ˆæœ¬ï¼Œä»æ ¹æœ¬ä¸Šé¿å…é˜»å¡é—®é¢˜ã€‚

### 2. æ€§èƒ½ç›‘æ§
æ·»åŠ æ€§èƒ½ç›‘æ§ï¼Œè‡ªåŠ¨æ£€æµ‹é˜»å¡æ“ä½œï¼š
```python
import time

async def monitor_blocking():
    start = time.time()
    result = await some_operation()
    elapsed = time.time() - start
    
    if elapsed > 5:
        logger.warning(f"âš ï¸  æ£€æµ‹åˆ°è€—æ—¶æ“ä½œ: {elapsed:.2f}ç§’")
```

### 3. åå°ä»»åŠ¡é˜Ÿåˆ—
å¯¹äºéå¸¸è€—æ—¶çš„æ“ä½œï¼Œä½¿ç”¨ Celery ç­‰ä»»åŠ¡é˜Ÿåˆ—ï¼š
```python
@celery_app.task
def test_data_sources_task():
    # åœ¨åå°workerä¸­æ‰§è¡Œ
    # ...
```

## âœ… æäº¤è®°å½•

```
commit 29ed0b9
fix: ä¿®å¤æ•°æ®æºæµ‹è¯•æ—¶å…¶ä»–APIæ¥å£è¶…æ—¶çš„é—®é¢˜

é—®é¢˜æè¿°ï¼š
- æ‰§è¡Œ /api/sync/multi-source/test-sources æ—¶ï¼Œå…¶ä»–æ¥å£ï¼ˆå¦‚ /api/notifications/unread_countï¼‰ä¼šè¶…æ—¶
- åŸå› ï¼šåŒæ­¥çš„è€—æ—¶æ“ä½œé˜»å¡äº† FastAPI çš„äº‹ä»¶å¾ªç¯

è§£å†³æ–¹æ¡ˆï¼š
1. ä½¿ç”¨ asyncio.to_thread() å°†åŒæ­¥æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹æ‰§è¡Œ
2. æå– _test_single_adapter() å‡½æ•°ï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯
3. ä½¿ç”¨ asyncio.gather() å¹¶å‘æµ‹è¯•æ‰€æœ‰æ•°æ®æº

æ”¹è¿›æ•ˆæœï¼š
- æ•°æ®æºæµ‹è¯•æœŸé—´ï¼Œå…¶ä»–æ¥å£æ­£å¸¸å“åº”ï¼ˆ< 1ç§’ï¼‰
- äº‹ä»¶å¾ªç¯ä¸è¢«é˜»å¡
- å¹¶å‘æµ‹è¯•æ‰€æœ‰æ•°æ®æºï¼Œé€Ÿåº¦æ›´å¿«
```

## ğŸ‘¥ å‚ä¸è€…

- **é—®é¢˜æŠ¥å‘Š**ï¼šç”¨æˆ·
- **é—®é¢˜åˆ†æ**ï¼šAI Assistant (Augment Agent)
- **è§£å†³æ–¹æ¡ˆ**ï¼šAI Assistant (Augment Agent)
- **æµ‹è¯•éªŒè¯**ï¼šå¾…ç”¨æˆ·ç¡®è®¤

## ğŸ“Œ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**å¼‚æ­¥ç¼–ç¨‹é™·é˜±**æ¡ˆä¾‹ï¼š

1. âŒ **é—®é¢˜**ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­è°ƒç”¨åŒæ­¥çš„è€—æ—¶æ“ä½œï¼Œé˜»å¡äº‹ä»¶å¾ªç¯
2. ğŸ” **ç—‡çŠ¶**ï¼šå…¶ä»–APIæ¥å£è¶…æ—¶ï¼Œç”¨æˆ·ä½“éªŒå·®
3. âœ… **è§£å†³**ï¼šä½¿ç”¨ `asyncio.to_thread()` å°†åŒæ­¥æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹
4. ğŸ‰ **æ•ˆæœ**ï¼šäº‹ä»¶å¾ªç¯ä¸è¢«é˜»å¡ï¼Œæ‰€æœ‰æ¥å£æ­£å¸¸å“åº”

**æ ¸å¿ƒåŸåˆ™**ï¼š
> åœ¨ FastAPI å¼‚æ­¥åº”ç”¨ä¸­ï¼Œæ°¸è¿œä¸è¦åœ¨äº‹ä»¶å¾ªç¯ä¸­ç›´æ¥è°ƒç”¨åŒæ­¥çš„è€—æ—¶æ“ä½œï¼

