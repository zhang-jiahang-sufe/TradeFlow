# combined_data æ•°æ®ç»“æ„åˆ†æ

## ğŸ“‹ æ¦‚è¿°

`combined_data` æ˜¯ `get_stock_fundamentals_unified` å·¥å…·è¿”å›çš„ç»¼åˆæ•°æ®ï¼ŒåŒ…å«äº†è‚¡ç¥¨çš„åŸºæœ¬é¢åˆ†ææ‰€éœ€çš„æ‰€æœ‰å…³é”®ä¿¡æ¯ã€‚è¿™ä¸ªå·¥å…·ä¼šæ ¹æ®è‚¡ç¥¨ç±»å‹ï¼ˆAè‚¡/æ¸¯è‚¡/ç¾è‚¡ï¼‰è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ•°æ®æºå¹¶è¿”å›æ ¼å¼åŒ–çš„æ•°æ®ã€‚

## âš ï¸ é‡è¦ï¼šæ•°æ®è·å–ä¼˜å…ˆçº§

### MongoDB ä¼˜å…ˆç­–ç•¥

**å¯¹äºAè‚¡æ•°æ®ï¼Œç³»ç»Ÿé‡‡ç”¨ MongoDB ä¼˜å…ˆç­–ç•¥**ï¼š

1. **ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šMongoDB æ•°æ®åº“**
   - å¦‚æœå¯ç”¨äº† `TA_USE_APP_CACHE` ç¯å¢ƒå˜é‡
   - ä¼˜å…ˆä»ä»¥ä¸‹ MongoDB é›†åˆè·å–æ•°æ®ï¼š
     - `market_quotes` - å®æ—¶è‚¡ä»·
     - `stock_financial_data` - è´¢åŠ¡æŒ‡æ ‡
     - `stock_basic_info` - åŸºç¡€ä¿¡æ¯
     - `stock_daily_data` - å†å²äº¤æ˜“æ•°æ®

2. **ç¬¬äºŒä¼˜å…ˆçº§ï¼šAPI æ•°æ®æº**
   - MongoDB æ•°æ®ä¸å¯ç”¨æˆ–ä¸å®Œæ•´æ—¶
   - æŒ‰é…ç½®çš„ä¼˜å…ˆçº§è°ƒç”¨ APIï¼š
     - AKShare APIï¼ˆé»˜è®¤ç¬¬ä¸€ä¼˜å…ˆçº§ï¼‰
     - Tushare APIï¼ˆé»˜è®¤ç¬¬äºŒä¼˜å…ˆçº§ï¼‰
     - BaoStock APIï¼ˆé»˜è®¤ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼‰

3. **æ•°æ®æºä¼˜å…ˆçº§é…ç½®**
   - å¯é€šè¿‡ Web ç•Œé¢çš„"æ•°æ®æºç®¡ç†"é…ç½®ä¼˜å…ˆçº§
   - é…ç½®å­˜å‚¨åœ¨ MongoDB `datasource_groupings` é›†åˆ
   - æ”¯æŒæŒ‰å¸‚åœºç±»åˆ«ï¼ˆAè‚¡/æ¸¯è‚¡/ç¾è‚¡ï¼‰è®¾ç½®ä¸åŒä¼˜å…ˆçº§

### ä¸ºä»€ä¹ˆ MongoDB ä¼˜å…ˆï¼Ÿ

- âœ… **æ€§èƒ½æ›´å¿«**ï¼šæœ¬åœ°æ•°æ®åº“æŸ¥è¯¢æ¯”APIè°ƒç”¨å¿«10-100å€
- âœ… **ç¨³å®šå¯é **ï¼šä¸å—APIé™æµã€ç½‘ç»œæ³¢åŠ¨å½±å“
- âœ… **æ•°æ®ä¸€è‡´**ï¼šå®šæ—¶åŒæ­¥ä»»åŠ¡ä¿è¯æ•°æ®æ–°é²œåº¦
- âœ… **æˆæœ¬æ›´ä½**ï¼šå‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œé™ä½è´¹ç”¨
- âœ… **ç¦»çº¿å¯ç”¨**ï¼šå³ä½¿APIä¸å¯ç”¨ä¹Ÿèƒ½ç»§ç»­åˆ†æ

## ğŸ¯ è°ƒç”¨ä½ç½®

åœ¨ `fundamentals_analyst.py` ç¬¬ 422-427 è¡Œï¼š

```python
combined_data = unified_tool.invoke({
    'ticker': ticker,
    'start_date': start_date,
    'end_date': current_date,
    'curr_date': current_date
})
```

## ğŸ“Š æ•°æ®ç»“æ„è¯¦è§£

### 1. æ€»ä½“ç»“æ„

`combined_data` æ˜¯ä¸€ä¸ª**å­—ç¬¦ä¸²ç±»å‹**çš„æ ¼å¼åŒ–æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š

```
# {ticker} åŸºæœ¬é¢åˆ†ææ•°æ®

**è‚¡ç¥¨ç±»å‹**: {å¸‚åœºåç§°}
**è´§å¸**: {è´§å¸åç§°} ({è´§å¸ç¬¦å·})
**åˆ†ææ—¥æœŸ**: {å½“å‰æ—¥æœŸ}
**æ•°æ®æ·±åº¦çº§åˆ«**: {æ•°æ®æ·±åº¦}

{å…·ä½“æ•°æ®æ¨¡å—}

---
*æ•°æ®æ¥æº: æ ¹æ®è‚¡ç¥¨ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„æ•°æ®æº*
```

### 2. é’ˆå¯¹ä¸åŒå¸‚åœºçš„æ•°æ®å†…å®¹

#### 2.1 ä¸­å›½Aè‚¡æ•°æ® (is_china=True)

å¯¹äºAè‚¡ï¼Œ`combined_data` åŒ…å«ä¸¤ä¸ªä¸»è¦æ¨¡å—ï¼š

##### æ¨¡å—1: Aè‚¡å½“å‰ä»·æ ¼ä¿¡æ¯

```markdown
## Aè‚¡å½“å‰ä»·æ ¼ä¿¡æ¯

è‚¡ç¥¨ä»£ç : {ticker}
è‚¡ç¥¨åç§°: {å…¬å¸åç§°}
äº¤æ˜“æ‰€: {ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€/æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€}
è¡Œä¸š: {æ‰€å±è¡Œä¸š}
æ¿å—: {ä¸»æ¿/åˆ›ä¸šæ¿/ç§‘åˆ›æ¿/åŒ—äº¤æ‰€}

=== æœ€æ–°ä»·æ ¼æ•°æ® ===
æ—¥æœŸ: {æœ€æ–°äº¤æ˜“æ—¥}
å¼€ç›˜ä»·: {å¼€ç›˜ä»·} å…ƒ
æœ€é«˜ä»·: {æœ€é«˜ä»·} å…ƒ
æœ€ä½ä»·: {æœ€ä½ä»·} å…ƒ
æ”¶ç›˜ä»·: {æ”¶ç›˜ä»·} å…ƒ
æˆäº¤é‡: {æˆäº¤é‡} è‚¡
æˆäº¤é¢: {æˆäº¤é¢} å…ƒ
æ¶¨è·Œå¹…: {æ¶¨è·Œå¹…}%
æ¢æ‰‹ç‡: {æ¢æ‰‹ç‡}%
```

**æ•°æ®æ¥æº**: `get_china_stock_data_unified()` å‡½æ•°
- **ç¬¬ä¸€ä¼˜å…ˆçº§**: MongoDB `stock_daily_data` é›†åˆï¼ˆå†å²äº¤æ˜“æ•°æ®ç¼“å­˜ï¼‰
- **ç¬¬äºŒä¼˜å…ˆçº§**: æŒ‰é…ç½®çš„æ•°æ®æºä¼˜å…ˆçº§ï¼ˆé»˜è®¤ï¼šTushare â†’ AKShare â†’ BaoStockï¼‰
- åŒ…å«æœ€è¿‘1-2å¤©çš„äº¤æ˜“æ•°æ®

##### æ¨¡å—2: Aè‚¡åŸºæœ¬é¢è´¢åŠ¡æ•°æ®

```markdown
## Aè‚¡åŸºæœ¬é¢è´¢åŠ¡æ•°æ®

### 1. å…¬å¸åŸºæœ¬ä¿¡æ¯
- è‚¡ç¥¨ä»£ç : {ticker}
- å…¬å¸åç§°: {å…¬å¸å…¨ç§°}
- æ‰€å±è¡Œä¸š: {è¡Œä¸šåˆ†ç±»}
- ä¸Šå¸‚æ¿å—: {ä¸»æ¿/åˆ›ä¸šæ¿/ç§‘åˆ›æ¿/åŒ—äº¤æ‰€}
- ä¸Šå¸‚æ—¥æœŸ: {ä¸Šå¸‚æ—¥æœŸ}

### 2. ä¼°å€¼æŒ‡æ ‡
- å¸‚ç›ˆç‡ (PE): {PEå€¼}
- å¸‚å‡€ç‡ (PB): {PBå€¼}
- å¸‚é”€ç‡ (PS): {PSå€¼}
- æ€»å¸‚å€¼: {æ€»å¸‚å€¼} äº¿å…ƒ
- æµé€šå¸‚å€¼: {æµé€šå¸‚å€¼} äº¿å…ƒ

### 3. è´¢åŠ¡æŒ‡æ ‡
- å‡€èµ„äº§æ”¶ç›Šç‡ (ROE): {ROE}%
- æ€»èµ„äº§æ”¶ç›Šç‡ (ROA): {ROA}%
- èµ„äº§è´Ÿå€ºç‡: {è´Ÿå€ºç‡}%
- æµåŠ¨æ¯”ç‡: {æµåŠ¨æ¯”ç‡}
- é€ŸåŠ¨æ¯”ç‡: {é€ŸåŠ¨æ¯”ç‡}
- æ¯›åˆ©ç‡: {æ¯›åˆ©ç‡}%
- å‡€åˆ©ç‡: {å‡€åˆ©ç‡}%

### 4. ç›ˆåˆ©èƒ½åŠ›åˆ†æ
- è¥ä¸šæ”¶å…¥: {è¥ä¸šæ”¶å…¥} äº¿å…ƒ
- å‡€åˆ©æ¶¦: {å‡€åˆ©æ¶¦} äº¿å…ƒ
- åŒæ¯”å¢é•¿ç‡: {å¢é•¿ç‡}%
- æ¯è‚¡æ”¶ç›Š (EPS): {EPS} å…ƒ

### 5. æˆé•¿æ€§åˆ†æ
- è¥æ”¶å¢é•¿ç‡: {è¥æ”¶å¢é•¿ç‡}%
- åˆ©æ¶¦å¢é•¿ç‡: {åˆ©æ¶¦å¢é•¿ç‡}%
- è¡Œä¸šåœ°ä½: {è¡Œä¸šæ’å/å¸‚åœºä»½é¢}

### 6. é£é™©è¯„ä¼°
- è´¢åŠ¡é£é™©: {ä½/ä¸­/é«˜}
- ç»è¥é£é™©: {ä½/ä¸­/é«˜}
- å¸‚åœºé£é™©: {ä½/ä¸­/é«˜}

### 7. æŠ•èµ„å»ºè®®
- ä¼°å€¼æ°´å¹³: {ä½ä¼°/åˆç†/é«˜ä¼°}
- åˆç†ä»·ä½åŒºé—´: {æœ€ä½ä»·} - {æœ€é«˜ä»·} å…ƒ
- ç›®æ ‡ä»·ä½: {ç›®æ ‡ä»·} å…ƒ
- æŠ•èµ„å»ºè®®: {ä¹°å…¥/æŒæœ‰/å–å‡º}
```

**æ•°æ®æ¥æº**: `OptimizedChinaDataProvider._generate_fundamentals_report()` æ–¹æ³•

æ•°æ®è·å–ä¼˜å…ˆçº§ï¼š
1. **MongoDB ä¼˜å…ˆ**ï¼ˆå¦‚æœå¯ç”¨ `TA_USE_APP_CACHE`ï¼‰ï¼š
   - `market_quotes` é›†åˆ â†’ å®æ—¶è‚¡ä»·
   - `stock_financial_data` é›†åˆ â†’ è´¢åŠ¡æŒ‡æ ‡ï¼ˆROEã€è´Ÿå€ºç‡ã€åˆ©æ¶¦ç­‰ï¼‰
   - `stock_basic_info` é›†åˆ â†’ åŸºç¡€ä¿¡æ¯ï¼ˆè¡Œä¸šã€æ¿å—ã€å¸‚å€¼ã€PEã€PBç­‰ï¼‰

2. **API æ•°æ®æº**ï¼ˆMongoDB æ— æ•°æ®æ—¶é™çº§ï¼‰ï¼š
   - AKShare API â†’ è´¢åŠ¡æ•°æ®
   - Tushare API â†’ è´¢åŠ¡æ•°æ®ï¼ˆAKShareå¤±è´¥æ—¶ï¼‰

3. **æ™ºèƒ½å¤„ç†**ï¼š
   - è§£æå’Œæ ‡å‡†åŒ–ä¸åŒæ¥æºçš„æ•°æ®æ ¼å¼
   - åŸºäºè¡Œä¸šç‰¹å¾è¿›è¡Œä¼°å€¼åˆ†æ
   - è®¡ç®—ç»¼åˆè¯„åˆ†ï¼ˆåŸºæœ¬é¢è¯„åˆ†ã€ä¼°å€¼è¯„åˆ†ã€æˆé•¿æ€§è¯„åˆ†ï¼‰

#### 2.2 æ¸¯è‚¡æ•°æ® (is_hk=True)

æ ¹æ®æ•°æ®æ·±åº¦çº§åˆ«ï¼Œæ¸¯è‚¡æ•°æ®åŒ…å«ä¸åŒçš„å†…å®¹ï¼š

##### åŸºç¡€çº§åˆ« (data_depth="basic" æˆ– "standard")

```markdown
## æ¸¯è‚¡åŸºç¡€ä¿¡æ¯

**è‚¡ç¥¨ä»£ç **: {ticker}
**è‚¡ç¥¨åç§°**: {å…¬å¸åç§°}
**äº¤æ˜“è´§å¸**: æ¸¯å¸ (HK$)
**äº¤æ˜“æ‰€**: é¦™æ¸¯äº¤æ˜“æ‰€ (HKG)
**æ•°æ®æº**: {æ•°æ®æºåç§°}

**åŸºæœ¬é¢åˆ†æå»ºè®®**ï¼š
- å»ºè®®æŸ¥çœ‹å…¬å¸æœ€æ–°è´¢æŠ¥
- å…³æ³¨æ¸¯è‚¡å¸‚åœºæ•´ä½“èµ°åŠ¿
- è€ƒè™‘æ±‡ç‡å› ç´ å¯¹æŠ•èµ„çš„å½±å“
```

##### å®Œæ•´çº§åˆ« (data_depth="full" æˆ– "detailed" æˆ– "comprehensive")

```markdown
## æ¸¯è‚¡æ•°æ®

### è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
- è‚¡ç¥¨ä»£ç : {ticker}
- å…¬å¸åç§°: {å…¬å¸åç§°}
- äº¤æ˜“è´§å¸: æ¸¯å¸ (HK$)
- äº¤æ˜“æ‰€: é¦™æ¸¯äº¤æ˜“æ‰€ (HKG)
- è¡Œä¸š: {æ‰€å±è¡Œä¸š}
- æ¿å—: {æ‰€å±æ¿å—}

### ä»·æ ¼æ•°æ®
- æœ€æ–°ä»·æ ¼: {æœ€æ–°ä»·} æ¸¯å¸
- å¼€ç›˜ä»·: {å¼€ç›˜ä»·} æ¸¯å¸
- æœ€é«˜ä»·: {æœ€é«˜ä»·} æ¸¯å¸
- æœ€ä½ä»·: {æœ€ä½ä»·} æ¸¯å¸
- æˆäº¤é‡: {æˆäº¤é‡}
- æˆäº¤é¢: {æˆäº¤é¢} æ¸¯å¸

### ä¼°å€¼æŒ‡æ ‡
- å¸‚å€¼: {å¸‚å€¼} æ¸¯å¸
- å¸‚ç›ˆç‡: {PE}
- å¸‚å‡€ç‡: {PB}
```

**æ•°æ®æ¥æº**: 
- `get_hk_stock_data_unified()` - ä½¿ç”¨ yfinance è·å–æ¸¯è‚¡æ•°æ®
- `get_hk_stock_info_unified()` - è·å–æ¸¯è‚¡åŸºç¡€ä¿¡æ¯

#### 2.3 ç¾è‚¡æ•°æ® (is_us=True)

æ ¹æ®æ•°æ®æ·±åº¦çº§åˆ«ï¼Œç¾è‚¡æ•°æ®åŒ…å«ä¸åŒçš„å†…å®¹ï¼š

##### åŸºç¡€çº§åˆ« (data_depth="basic" æˆ– "standard")

```markdown
## ç¾è‚¡åŸºç¡€ä¿¡æ¯

**è‚¡ç¥¨ä»£ç **: {ticker}
**è‚¡ç¥¨ç±»å‹**: ç¾è‚¡
**äº¤æ˜“è´§å¸**: ç¾å…ƒ (USD)
**äº¤æ˜“æ‰€**: ç¾å›½è¯åˆ¸äº¤æ˜“æ‰€

**åŸºæœ¬é¢åˆ†æå»ºè®®**ï¼š
- å»ºè®®æŸ¥çœ‹å…¬å¸æœ€æ–°è´¢æŠ¥
- å…³æ³¨ç¾è‚¡å¸‚åœºæ•´ä½“èµ°åŠ¿
- è€ƒè™‘ç¾å…ƒæ±‡ç‡å› ç´ å¯¹æŠ•èµ„çš„å½±å“
- å…³æ³¨ç¾è”å‚¨æ”¿ç­–å¯¹è‚¡å¸‚çš„å½±å“
```

##### å®Œæ•´çº§åˆ« (data_depth="full" æˆ– "detailed" æˆ– "comprehensive")

```markdown
## ç¾è‚¡åŸºæœ¬é¢æ•°æ®

### å…¬å¸ä¿¡æ¯
- è‚¡ç¥¨ä»£ç : {ticker}
- å…¬å¸åç§°: {å…¬å¸åç§°}
- äº¤æ˜“è´§å¸: ç¾å…ƒ (USD)
- è¡Œä¸š: {æ‰€å±è¡Œä¸š}
- æ¿å—: {æ‰€å±æ¿å—}

### è´¢åŠ¡æ•°æ®
- å¸‚å€¼: {å¸‚å€¼} ç¾å…ƒ
- å¸‚ç›ˆç‡ (PE): {PE}
- å¸‚å‡€ç‡ (PB): {PB}
- è¥ä¸šæ”¶å…¥: {è¥ä¸šæ”¶å…¥} ç¾å…ƒ
- å‡€åˆ©æ¶¦: {å‡€åˆ©æ¶¦} ç¾å…ƒ
- æ¯è‚¡æ”¶ç›Š (EPS): {EPS} ç¾å…ƒ

### åˆ†æå¸ˆè§‚ç‚¹
- ç›®æ ‡ä»·: {ç›®æ ‡ä»·} ç¾å…ƒ
- è¯„çº§: {ä¹°å…¥/æŒæœ‰/å–å‡º}
```

**æ•°æ®æ¥æº**: `get_fundamentals_openai()` - ä½¿ç”¨ OpenAI æˆ– Finnhub API

## ğŸ” æ•°æ®æ¥æºæ€»ç»“

### Aè‚¡ï¼ˆä¸­å›½è‚¡ç¥¨ï¼‰- MongoDB ä¼˜å…ˆ
**ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šMongoDB æ•°æ®åº“**
- `market_quotes` - å®æ—¶è¡Œæƒ…
- `stock_financial_data` - è´¢åŠ¡æ•°æ®
- `stock_basic_info` - åŸºç¡€ä¿¡æ¯
- `stock_daily_data` - å†å²æ•°æ®

**ç¬¬äºŒä¼˜å…ˆçº§ï¼šAPI æ•°æ®æº**ï¼ˆé™çº§ç­–ç•¥ï¼‰
- AKShare APIï¼ˆé»˜è®¤ç¬¬ä¸€APIä¼˜å…ˆçº§ï¼‰
- Tushare APIï¼ˆé»˜è®¤ç¬¬äºŒAPIä¼˜å…ˆçº§ï¼‰
- BaoStock APIï¼ˆé»˜è®¤ç¬¬ä¸‰APIä¼˜å…ˆçº§ï¼‰

### æ¸¯è‚¡
- yfinance APIï¼ˆä¸»è¦ï¼‰
- AKShare APIï¼ˆå¤‡ç”¨ï¼‰

### ç¾è‚¡
- OpenAI APIï¼ˆä¸»è¦ï¼‰
- Finnhub APIï¼ˆå¤‡ç”¨ï¼‰

## ğŸ” æ•°æ®æ·±åº¦çº§åˆ«è¯´æ˜

`combined_data` çš„è¯¦ç»†ç¨‹åº¦ç”± `data_depth` å‚æ•°æ§åˆ¶ï¼š

| çº§åˆ« | è¯´æ˜ | åŒ…å«å†…å®¹ |
|------|------|----------|
| `basic` | å¿«é€Ÿåˆ†æ | åŸºç¡€ä¿¡æ¯ + å½“å‰ä»·æ ¼ |
| `standard` | æ ‡å‡†åˆ†æ | åŸºç¡€ä¿¡æ¯ + å½“å‰ä»·æ ¼ + åŸºç¡€ä¼°å€¼æŒ‡æ ‡ |
| `full` | æ·±åº¦åˆ†æ | å®Œæ•´çš„ä»·æ ¼æ•°æ® + è´¢åŠ¡æŒ‡æ ‡ + ä¼°å€¼åˆ†æ |
| `detailed` | è¯¦ç»†åˆ†æ | å®Œæ•´æ•°æ® + è¯¦ç»†è´¢åŠ¡åˆ†æ |
| `comprehensive` | å…¨é¢åˆ†æ | æ‰€æœ‰å¯ç”¨æ•°æ® + æ·±åº¦åˆ†æ + æŠ•èµ„å»ºè®® |

## ğŸ“ˆ æ•°æ®å­—æ®µè¯¦è§£

### ä»·æ ¼ç›¸å…³å­—æ®µ
- **å¼€ç›˜ä»· (open)**: å½“æ—¥å¼€ç›˜æ—¶çš„ä»·æ ¼
- **æœ€é«˜ä»· (high)**: å½“æ—¥æœ€é«˜ä»·æ ¼
- **æœ€ä½ä»· (low)**: å½“æ—¥æœ€ä½ä»·æ ¼
- **æ”¶ç›˜ä»· (close)**: å½“æ—¥æ”¶ç›˜ä»·æ ¼
- **æˆäº¤é‡ (volume)**: å½“æ—¥æˆäº¤è‚¡ç¥¨æ•°é‡
- **æˆäº¤é¢ (amount)**: å½“æ—¥æˆäº¤é‡‘é¢æ€»é¢
- **æ¶¨è·Œå¹… (change_percent)**: ç›¸å¯¹å‰ä¸€äº¤æ˜“æ—¥çš„æ¶¨è·Œç™¾åˆ†æ¯”
- **æ¢æ‰‹ç‡ (turnover_rate)**: æˆäº¤é‡å æµé€šè‚¡æœ¬çš„æ¯”ä¾‹

### ä¼°å€¼æŒ‡æ ‡å­—æ®µ
- **å¸‚ç›ˆç‡ (PE)**: è‚¡ä»· / æ¯è‚¡æ”¶ç›Šï¼Œè¡¡é‡è‚¡ç¥¨ä¼°å€¼æ°´å¹³
- **å¸‚å‡€ç‡ (PB)**: è‚¡ä»· / æ¯è‚¡å‡€èµ„äº§ï¼Œè¡¡é‡èµ„äº§ä»·å€¼
- **å¸‚é”€ç‡ (PS)**: å¸‚å€¼ / è¥ä¸šæ”¶å…¥ï¼Œè¡¡é‡é”€å”®èƒ½åŠ›
- **æ€»å¸‚å€¼ (total_mv)**: è‚¡ä»· Ã— æ€»è‚¡æœ¬
- **æµé€šå¸‚å€¼ (circ_mv)**: è‚¡ä»· Ã— æµé€šè‚¡æœ¬

### è´¢åŠ¡æŒ‡æ ‡å­—æ®µ
- **å‡€èµ„äº§æ”¶ç›Šç‡ (ROE)**: å‡€åˆ©æ¶¦ / å‡€èµ„äº§ï¼Œè¡¡é‡ç›ˆåˆ©èƒ½åŠ›
- **æ€»èµ„äº§æ”¶ç›Šç‡ (ROA)**: å‡€åˆ©æ¶¦ / æ€»èµ„äº§ï¼Œè¡¡é‡èµ„äº§ä½¿ç”¨æ•ˆç‡
- **èµ„äº§è´Ÿå€ºç‡ (debt_ratio)**: è´Ÿå€º / èµ„äº§ï¼Œè¡¡é‡è´¢åŠ¡é£é™©
- **æµåŠ¨æ¯”ç‡ (current_ratio)**: æµåŠ¨èµ„äº§ / æµåŠ¨è´Ÿå€ºï¼Œè¡¡é‡çŸ­æœŸå¿å€ºèƒ½åŠ›
- **é€ŸåŠ¨æ¯”ç‡ (quick_ratio)**: (æµåŠ¨èµ„äº§ - å­˜è´§) / æµåŠ¨è´Ÿå€º
- **æ¯›åˆ©ç‡ (gross_margin)**: (è¥ä¸šæ”¶å…¥ - è¥ä¸šæˆæœ¬) / è¥ä¸šæ”¶å…¥
- **å‡€åˆ©ç‡ (net_margin)**: å‡€åˆ©æ¶¦ / è¥ä¸šæ”¶å…¥

## ğŸ”§ æ•°æ®è·å–æµç¨‹

### Aè‚¡æ•°æ®è·å–æµç¨‹ï¼ˆé‡ç‚¹ï¼‰

```mermaid
graph TD
    A[è°ƒç”¨ get_stock_fundamentals_unified] --> B{è¯†åˆ«è‚¡ç¥¨ç±»å‹}
    B -->|Aè‚¡| C[Aè‚¡æ•°æ®è·å–]

    C --> C1[ä»·æ ¼æ•°æ®è·å–]
    C1 --> C1A{MongoDBå¯ç”¨?}
    C1A -->|æ˜¯| C1B[MongoDB stock_daily_data]
    C1A -->|å¦| C1C[APIæ•°æ®æº<br/>Tushare/AKShare]

    C --> C2[åŸºæœ¬é¢æ•°æ®è·å–]
    C2 --> C2A{TA_USE_APP_CACHE?}
    C2A -->|æ˜¯| C2B[MongoDBä¼˜å…ˆ]
    C2A -->|å¦| C2C[ç›´æ¥API]

    C2B --> C2B1[market_quotes<br/>å®æ—¶è‚¡ä»·]
    C2B --> C2B2[stock_financial_data<br/>è´¢åŠ¡æŒ‡æ ‡]
    C2B --> C2B3[stock_basic_info<br/>åŸºç¡€ä¿¡æ¯]

    C2B1 --> C2D{æ•°æ®å®Œæ•´?}
    C2B2 --> C2D
    C2B3 --> C2D

    C2D -->|æ˜¯| F[ç»„åˆæ•°æ®]
    C2D -->|å¦| C2E[é™çº§åˆ°API]
    C2E --> C2E1[AKShare API]
    C2E1 --> C2F{æˆåŠŸ?}
    C2F -->|æ˜¯| F
    C2F -->|å¦| C2G[Tushare API]
    C2G --> F

    C2C --> C2E1

    C1B --> F
    C1C --> F

    F --> G[è¿”å› combined_data]
```

### å®Œæ•´æµç¨‹ï¼ˆæ‰€æœ‰å¸‚åœºï¼‰

```mermaid
graph TD
    A[è°ƒç”¨ get_stock_fundamentals_unified] --> B{è¯†åˆ«è‚¡ç¥¨ç±»å‹}
    B -->|Aè‚¡| C[è·å–Aè‚¡æ•°æ®<br/>MongoDBä¼˜å…ˆ]
    B -->|æ¸¯è‚¡| D[è·å–æ¸¯è‚¡æ•°æ®<br/>yfinance]
    B -->|ç¾è‚¡| E[è·å–ç¾è‚¡æ•°æ®<br/>OpenAI/Finnhub]

    C --> F[ç»„åˆæ•°æ®]
    D --> F
    E --> F

    F --> G[è¿”å› combined_data]
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: Aè‚¡åŸºæœ¬é¢åˆ†æ

```python
# è¾“å…¥å‚æ•°
ticker = "000001"  # å¹³å®‰é“¶è¡Œ
start_date = "2025-05-28"
end_date = "2025-11-04"
curr_date = "2025-11-04"

# è¿”å›çš„ combined_data åŒ…å«:
"""
# 000001 åŸºæœ¬é¢åˆ†ææ•°æ®

**è‚¡ç¥¨ç±»å‹**: ä¸­å›½Aè‚¡
**è´§å¸**: äººæ°‘å¸ (Â¥)
**åˆ†ææ—¥æœŸ**: 2025-11-04
**æ•°æ®æ·±åº¦çº§åˆ«**: standard

## Aè‚¡å½“å‰ä»·æ ¼ä¿¡æ¯
è‚¡ç¥¨ä»£ç : 000001
è‚¡ç¥¨åç§°: å¹³å®‰é“¶è¡Œ
äº¤æ˜“æ‰€: æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€
è¡Œä¸š: é“¶è¡Œ
æ¿å—: ä¸»æ¿

=== æœ€æ–°ä»·æ ¼æ•°æ® ===
æ—¥æœŸ: 2025-11-04
æ”¶ç›˜ä»·: 13.45 å…ƒ
æ¶¨è·Œå¹…: +1.2%
æˆäº¤é‡: 45678900 è‚¡
æ¢æ‰‹ç‡: 0.85%

## Aè‚¡åŸºæœ¬é¢è´¢åŠ¡æ•°æ®
### ä¼°å€¼æŒ‡æ ‡
- å¸‚ç›ˆç‡ (PE): 4.94
- å¸‚å‡€ç‡ (PB): 0.50
- æ€»å¸‚å€¼: 2200.63 äº¿å…ƒ

### è´¢åŠ¡æŒ‡æ ‡
- å‡€èµ„äº§æ”¶ç›Šç‡ (ROE): 4.95%
- èµ„äº§è´Ÿå€ºç‡: 91.32%

### æŠ•èµ„å»ºè®®
- ä¼°å€¼æ°´å¹³: ä½ä¼°
- æŠ•èµ„å»ºè®®: ä¹°å…¥
"""
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®æ ¼å¼**: `combined_data` æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä½¿ç”¨ Markdown æ ¼å¼åŒ–
2. **æ•°æ®å®Œæ•´æ€§**: æ ¹æ®æ•°æ®æºå¯ç”¨æ€§ï¼ŒæŸäº›å­—æ®µå¯èƒ½ä¸ºç©ºæˆ–æ˜¾ç¤º"å¾…åˆ†æ"
3. **æ•°æ®æ—¶æ•ˆæ€§**: ä»·æ ¼æ•°æ®ä¸ºæœ€è¿‘äº¤æ˜“æ—¥æ•°æ®ï¼Œè´¢åŠ¡æ•°æ®ä¸ºæœ€æ–°è´¢æŠ¥æ•°æ®
4. **è´§å¸å•ä½**: 
   - Aè‚¡ä½¿ç”¨äººæ°‘å¸ (Â¥)
   - æ¸¯è‚¡ä½¿ç”¨æ¸¯å¸ (HK$)
   - ç¾è‚¡ä½¿ç”¨ç¾å…ƒ (USD)
5. **é”™è¯¯å¤„ç†**: å¦‚æœæ•°æ®è·å–å¤±è´¥ï¼Œä¼šåŒ…å«é”™è¯¯ä¿¡æ¯å’Œå»ºè®®

## ğŸ“¦ MongoDB é›†åˆè¯´æ˜

### 1. `market_quotes` - å®æ—¶è¡Œæƒ…æ•°æ®
å­˜å‚¨è‚¡ç¥¨çš„å®æ—¶ä»·æ ¼ä¿¡æ¯ï¼š
- `code`: 6ä½è‚¡ç¥¨ä»£ç 
- `close`: æ”¶ç›˜ä»·
- `open`: å¼€ç›˜ä»·
- `high`: æœ€é«˜ä»·
- `low`: æœ€ä½ä»·
- `volume`: æˆäº¤é‡
- `amount`: æˆäº¤é¢
- `change_percent`: æ¶¨è·Œå¹…
- `turnover_rate`: æ¢æ‰‹ç‡

### 2. `stock_financial_data` - è´¢åŠ¡æ•°æ®
å­˜å‚¨è‚¡ç¥¨çš„è´¢åŠ¡æŒ‡æ ‡ï¼š
- `code`/`symbol`: è‚¡ç¥¨ä»£ç 
- `report_period`: æŠ¥å‘ŠæœŸï¼ˆå¦‚ï¼š20250630ï¼‰
- `data_source`: æ•°æ®æ¥æºï¼ˆtushare/akshareï¼‰
- `financial_indicators`: è´¢åŠ¡æŒ‡æ ‡å¯¹è±¡
  - `roe`: å‡€èµ„äº§æ”¶ç›Šç‡
  - `roa`: æ€»èµ„äº§æ”¶ç›Šç‡
  - `debt_to_assets`: èµ„äº§è´Ÿå€ºç‡
  - `current_ratio`: æµåŠ¨æ¯”ç‡
  - `quick_ratio`: é€ŸåŠ¨æ¯”ç‡
  - `gross_margin`: æ¯›åˆ©ç‡
  - `net_margin`: å‡€åˆ©ç‡

### 3. `stock_basic_info` - åŸºç¡€ä¿¡æ¯
å­˜å‚¨è‚¡ç¥¨çš„åŸºæœ¬ä¿¡æ¯ï¼š
- `code`: 6ä½è‚¡ç¥¨ä»£ç 
- `name`: è‚¡ç¥¨åç§°
- `industry`: æ‰€å±è¡Œä¸š
- `market`: æ¿å—ï¼ˆä¸»æ¿/åˆ›ä¸šæ¿/ç§‘åˆ›æ¿/åŒ—äº¤æ‰€ï¼‰
- `pe`: å¸‚ç›ˆç‡
- `pb`: å¸‚å‡€ç‡
- `total_mv`: æ€»å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰
- `circ_mv`: æµé€šå¸‚å€¼ï¼ˆäº¿å…ƒï¼‰
- `source`: æ•°æ®æ¥æºï¼ˆtushare/akshare/baostockï¼‰

### 4. `stock_daily_data` - å†å²äº¤æ˜“æ•°æ®
å­˜å‚¨è‚¡ç¥¨çš„å†å²æ—¥çº¿æ•°æ®ï¼ˆç”¨äºæŠ€æœ¯åˆ†æï¼‰

## ğŸ”— ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- **å·¥å…·å®šä¹‰**: `tradingagents/agents/utils/agent_utils.py` (ç¬¬ 770-1164 è¡Œ)
  - `get_stock_fundamentals_unified()` ç»Ÿä¸€åŸºæœ¬é¢åˆ†æå·¥å…·

- **Aè‚¡æ•°æ®å¤„ç†**: `tradingagents/dataflows/optimized_china_data.py`
  - `OptimizedChinaDataProvider` ç±»
  - `_get_real_financial_metrics()` - MongoDBä¼˜å…ˆçš„è´¢åŠ¡æ•°æ®è·å–
  - `_generate_fundamentals_report()` - åŸºæœ¬é¢æŠ¥å‘Šç”Ÿæˆ

### MongoDB ç›¸å…³
- **MongoDBç¼“å­˜é€‚é…å™¨**: `tradingagents/dataflows/cache/mongodb_cache_adapter.py`
  - `get_stock_basic_info()` - æŒ‰æ•°æ®æºä¼˜å…ˆçº§è·å–åŸºç¡€ä¿¡æ¯
  - `get_financial_data()` - æŒ‰æ•°æ®æºä¼˜å…ˆçº§è·å–è´¢åŠ¡æ•°æ®
  - `_get_data_source_priority()` - è·å–æ•°æ®æºä¼˜å…ˆçº§é…ç½®

- **æ•°æ®åº“ç®¡ç†**: `tradingagents/config/database_manager.py`
  - MongoDB è¿æ¥ç®¡ç†
  - æ•°æ®åº“å¯ç”¨æ€§æ£€æŸ¥

### å…¶ä»–å¸‚åœº
- **æ¸¯è‚¡æ•°æ®**: `tradingagents/dataflows/providers/hk/improved_hk.py`
- **ç¾è‚¡æ•°æ®**: `tradingagents/dataflows/interface.py`
- **æ•°æ®æºç®¡ç†**: `tradingagents/dataflows/data_source_manager.py`

### é…ç½®ç›¸å…³
- **è¿è¡Œæ—¶é…ç½®**: `tradingagents/config/runtime_settings.py`
  - `use_app_cache_enabled()` - æ£€æŸ¥æ˜¯å¦å¯ç”¨MongoDBç¼“å­˜

- **ç»Ÿä¸€é…ç½®**: `app/core/unified_config.py`
  - æ•°æ®æºä¼˜å…ˆçº§é…ç½®ç®¡ç†

