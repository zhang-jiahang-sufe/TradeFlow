# å‰ç«¯è®¤è¯ç®¡ç†ä¼˜åŒ–

## é—®é¢˜æè¿°

ä¹‹å‰å‰ç«¯çš„è®¤è¯ç®¡ç†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **401 é”™è¯¯å¤„ç†ä¸å®Œæ•´**ï¼šåªåœ¨å“åº”æ‹¦æˆªå™¨çš„é”™è¯¯å¤„ç†ä¸­å¤„ç† HTTP 401ï¼Œä½†å¦‚æœåç«¯è¿”å› `{success: false, code: 401}` çš„ä¸šåŠ¡é”™è¯¯ï¼ˆHTTP 200ï¼‰ï¼Œä¸ä¼šè§¦å‘è·³è½¬ç™»å½•é¡µ
2. **ä¸šåŠ¡é”™è¯¯ç æœªæ£€æŸ¥è®¤è¯å¤±è´¥**ï¼š`handleBusinessError` å‡½æ•°æ²¡æœ‰æ£€æŸ¥è®¤è¯ç›¸å…³çš„ä¸šåŠ¡é”™è¯¯ç ï¼ˆ401, 40101, 40102, 40103ï¼‰
3. **Token åˆ·æ–°å¯èƒ½å¤±è´¥ä½†æ²¡æœ‰ç»Ÿä¸€å¤„ç†**ï¼šæŸäº›æ¥å£å¯èƒ½è¿”å› 401 ä½†æ²¡æœ‰æ­£ç¡®è·³è½¬ç™»å½•é¡µ
4. **ç¼ºå°‘ Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶**ï¼šToken è¿‡æœŸå‰æ²¡æœ‰è‡ªåŠ¨åˆ·æ–°ï¼Œå¯¼è‡´ç”¨æˆ·æ“ä½œæ—¶çªç„¶å¤±æ•ˆ

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ç»Ÿä¸€è®¤è¯é”™è¯¯å¤„ç†

#### 1.1 å“åº”æ‹¦æˆªå™¨ä¼˜åŒ–

**æ–‡ä»¶**: `frontend/src/api/request.ts`

**ä¼˜åŒ–å†…å®¹**ï¼š
- åœ¨æˆåŠŸå“åº”ä¸­æ£€æŸ¥ä¸šåŠ¡é”™è¯¯ç ï¼ˆ401, 40101, 40102, 40103ï¼‰
- ä¼˜å…ˆå¤„ç†è®¤è¯é”™è¯¯ï¼Œä¸ä¾èµ– `skipErrorHandler` é…ç½®
- ç»Ÿä¸€è·³è½¬ç™»å½•é¡µé€»è¾‘

```typescript
// å“åº”æ‹¦æˆªå™¨ - æˆåŠŸå“åº”å¤„ç†
instance.interceptors.response.use(
  (response: AxiosResponse) => {
    // æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€ç 
    const data = response.data as ApiResponse
    if (data && typeof data === 'object' && 'success' in data) {
      if (!data.success) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯ï¼ˆä¼˜å…ˆå¤„ç†ï¼Œä¸ä¾èµ– skipErrorHandlerï¼‰
        const code = data.code
        if (code === 401 || code === 40101 || code === 40102 || code === 40103) {
          console.log('ğŸ”’ ä¸šåŠ¡é”™è¯¯ï¼šè®¤è¯å¤±è´¥ (HTTP 200)ï¼Œè·³è½¬ç™»å½•é¡µ')
          authStore.clearAuthInfo()
          router.push('/login')
          ElMessage.error(data.message || 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
          return Promise.reject(new Error(data.message || 'è®¤è¯å¤±è´¥'))
        }
        
        // å…¶ä»–ä¸šåŠ¡é”™è¯¯
        if (!config.skipErrorHandler) {
          handleBusinessError(data)
          return Promise.reject(new Error(data.message || 'è¯·æ±‚å¤±è´¥'))
        }
      }
    }

    return response.data
  },
  // ... é”™è¯¯å“åº”å¤„ç†
)
```

#### 1.2 ä¸šåŠ¡é”™è¯¯å¤„ç†ä¼˜åŒ–

**æ–‡ä»¶**: `frontend/src/api/request.ts`

**ä¼˜åŒ–å†…å®¹**ï¼š
- åœ¨ `handleBusinessError` å‡½æ•°ä¸­æ·»åŠ è®¤è¯é”™è¯¯ç å¤„ç†
- ç»Ÿä¸€è®¤è¯é”™è¯¯çš„å¤„ç†é€»è¾‘

```typescript
const handleBusinessError = (data: ApiResponse) => {
  const { code, message } = data
  const authStore = useAuthStore()

  switch (code) {
    case 401:
    case 40101:  // æœªæˆæƒ
    case 40102:  // Token æ— æ•ˆ
    case 40103:  // Token è¿‡æœŸ
      console.log('ğŸ”’ ä¸šåŠ¡é”™è¯¯ï¼šè®¤è¯å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ')
      authStore.clearAuthInfo()
      router.push('/login')
      ElMessage.error(message || 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
      break
    // ... å…¶ä»–é”™è¯¯ç å¤„ç†
  }
}
```

### 2. å…¨å±€é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `frontend/src/main.ts`

**ä¼˜åŒ–å†…å®¹**ï¼š
- åœ¨å…¨å±€é”™è¯¯å¤„ç†å™¨ä¸­æ•è·æœªå¤„ç†çš„è®¤è¯é”™è¯¯
- ç¡®ä¿æ‰€æœ‰è®¤è¯é”™è¯¯éƒ½èƒ½è·³è½¬åˆ°ç™»å½•é¡µ

```typescript
app.config.errorHandler = (err, vm, info) => {
  console.error('å…¨å±€é”™è¯¯:', err, info)
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
  if (err && typeof err === 'object') {
    const error = err as any
    if (
      error.message?.includes('è®¤è¯å¤±è´¥') ||
      error.message?.includes('ç™»å½•å·²è¿‡æœŸ') ||
      error.message?.includes('Token') ||
      error.response?.status === 401 ||
      error.code === 401
    ) {
      console.log('ğŸ”’ å…¨å±€é”™è¯¯å¤„ç†ï¼šæ£€æµ‹åˆ°è®¤è¯é”™è¯¯ï¼Œè·³è½¬ç™»å½•é¡µ')
      const authStore = useAuthStore()
      authStore.clearAuthInfo()
      router.push('/login')
    }
  }
}
```

### 3. Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

**æ–‡ä»¶**: `frontend/src/utils/auth.ts`

**æ–°å¢åŠŸèƒ½**ï¼š
- `isTokenValid()`: æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
- `parseToken()`: è§£æ token è·å– payload
- `getTokenRemainingTime()`: è·å– token å‰©ä½™æœ‰æ•ˆæ—¶é—´
- `isTokenExpiringSoon()`: æ£€æŸ¥ token æ˜¯å¦å³å°†è¿‡æœŸï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
- `autoRefreshToken()`: è‡ªåŠ¨åˆ·æ–°å³å°†è¿‡æœŸçš„ token
- `setupTokenRefreshTimer()`: è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥å¹¶åˆ·æ–° token

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å¯åŠ¨å®šæ—¶å™¨
import { setupTokenRefreshTimer } from '@/utils/auth'

// ç”¨æˆ·ç™»å½•æˆåŠŸå
if (authStore.isAuthenticated) {
  setupTokenRefreshTimer()
}
```

### 4. è®¤è¯å·¥å…·å‡½æ•°

**æ–‡ä»¶**: `frontend/src/utils/auth.ts`

**æ–°å¢åŠŸèƒ½**ï¼š
- `isAuthError()`: æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
- `handleAuthError()`: ç»Ÿä¸€å¤„ç†è®¤è¯é”™è¯¯
- Token ç›¸å…³å·¥å…·å‡½æ•°

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
import { isAuthError, handleAuthError } from '@/utils/auth'

try {
  const response = await api.getData()
} catch (error) {
  if (isAuthError(error)) {
    handleAuthError(error)
  } else {
    // å¤„ç†å…¶ä»–é”™è¯¯
  }
}
```

## è®¤è¯é”™è¯¯ç è§„èŒƒ

### HTTP çŠ¶æ€ç 
- `401`: æœªæˆæƒï¼ˆUnauthorizedï¼‰

### ä¸šåŠ¡é”™è¯¯ç 
- `401`: è®¤è¯å¤±è´¥ï¼ˆé€šç”¨ï¼‰
- `40101`: æœªæˆæƒï¼ˆæœªç™»å½•ï¼‰
- `40102`: Token æ— æ•ˆ
- `40103`: Token è¿‡æœŸ

## è®¤è¯æµç¨‹

### 1. ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
è°ƒç”¨ç™»å½• API
    â†“
åç«¯éªŒè¯æˆåŠŸï¼Œè¿”å› access_token å’Œ refresh_token
    â†“
å‰ç«¯ä¿å­˜ token åˆ° localStorage å’Œ Pinia store
    â†“
è®¾ç½® axios è¯·æ±‚å¤´ Authorization
    â†“
å¯åŠ¨ token è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
    â†“
è·³è½¬åˆ°ç›®æ ‡é¡µé¢
```

### 2. Token åˆ·æ–°æµç¨‹

```
å®šæ—¶å™¨æ¯åˆ†é’Ÿæ£€æŸ¥ token
    â†“
æ£€æŸ¥ token æ˜¯å¦å³å°†è¿‡æœŸï¼ˆ< 5 åˆ†é’Ÿï¼‰
    â†“
å¦‚æœå³å°†è¿‡æœŸï¼Œè°ƒç”¨åˆ·æ–° API
    â†“
ä½¿ç”¨ refresh_token è·å–æ–°çš„ access_token
    â†“
æ›´æ–° localStorage å’Œ Pinia store
    â†“
æ›´æ–° axios è¯·æ±‚å¤´
```

### 3. è®¤è¯å¤±è´¥å¤„ç†æµç¨‹

```
API è¯·æ±‚è¿”å› 401 æˆ–è®¤è¯é”™è¯¯ç 
    â†“
å“åº”æ‹¦æˆªå™¨æ•è·é”™è¯¯
    â†“
æ£€æŸ¥æ˜¯å¦æ˜¯ refresh è¯·æ±‚æœ¬èº«å¤±è´¥
    â†“
å¦‚æœä¸æ˜¯ï¼Œå°è¯•åˆ·æ–° token
    â†“
å¦‚æœåˆ·æ–°æˆåŠŸï¼Œé‡è¯•åŸè¯·æ±‚
    â†“
å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤è®¤è¯ä¿¡æ¯
    â†“
è·³è½¬åˆ°ç™»å½•é¡µ
    â†“
æ˜¾ç¤ºé”™è¯¯æç¤º
```

## æµ‹è¯•åœºæ™¯

### 1. Token è¿‡æœŸæµ‹è¯•

**åœºæ™¯**: ç”¨æˆ·é•¿æ—¶é—´æœªæ“ä½œï¼Œtoken è¿‡æœŸ

**é¢„æœŸè¡Œä¸º**:
1. ç”¨æˆ·æ“ä½œæ—¶ï¼ŒAPI è¿”å› 401
2. å‰ç«¯è‡ªåŠ¨å°è¯•åˆ·æ–° token
3. å¦‚æœåˆ·æ–°æˆåŠŸï¼Œç»§ç»­åŸæ“ä½œ
4. å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ

### 2. Refresh Token è¿‡æœŸæµ‹è¯•

**åœºæ™¯**: refresh_token ä¹Ÿè¿‡æœŸäº†

**é¢„æœŸè¡Œä¸º**:
1. ç”¨æˆ·æ“ä½œæ—¶ï¼ŒAPI è¿”å› 401
2. å‰ç«¯å°è¯•åˆ·æ–° tokenï¼Œä½† refresh_token ä¹Ÿæ— æ•ˆ
3. æ¸…é™¤è®¤è¯ä¿¡æ¯
4. è·³è½¬åˆ°ç™»å½•é¡µ
5. æ˜¾ç¤º"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"

### 3. ä¸šåŠ¡é”™è¯¯ç æµ‹è¯•

**åœºæ™¯**: åç«¯è¿”å› HTTP 200ï¼Œä½† `{success: false, code: 401}`

**é¢„æœŸè¡Œä¸º**:
1. å“åº”æ‹¦æˆªå™¨æ£€æµ‹åˆ°ä¸šåŠ¡é”™è¯¯ç  401
2. æ¸…é™¤è®¤è¯ä¿¡æ¯
3. è·³è½¬åˆ°ç™»å½•é¡µ
4. æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯

### 4. Token è‡ªåŠ¨åˆ·æ–°æµ‹è¯•

**åœºæ™¯**: Token å³å°†è¿‡æœŸï¼ˆå‰©ä½™ < 5 åˆ†é’Ÿï¼‰

**é¢„æœŸè¡Œä¸º**:
1. å®šæ—¶å™¨æ£€æµ‹åˆ° token å³å°†è¿‡æœŸ
2. è‡ªåŠ¨è°ƒç”¨åˆ·æ–° API
3. æ›´æ–° token
4. ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œç»§ç»­æ“ä½œ

## æ³¨æ„äº‹é¡¹

1. **é¿å…æ— é™å¾ªç¯**: å¦‚æœ refresh è¯·æ±‚æœ¬èº«è¿”å› 401ï¼Œä¸è¦å†æ¬¡å°è¯•åˆ·æ–°
2. **ç½‘ç»œé”™è¯¯å¤„ç†**: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼ˆ5xxï¼‰ä¸è¦æ¸…é™¤è®¤è¯ä¿¡æ¯
3. **å¹¶å‘è¯·æ±‚**: å¤šä¸ªè¯·æ±‚åŒæ—¶è¿”å› 401 æ—¶ï¼Œåªåˆ·æ–°ä¸€æ¬¡ token
4. **è·¯ç”±å®ˆå«**: ç¡®ä¿è·¯ç”±å®ˆå«å’Œ API æ‹¦æˆªå™¨çš„è®¤è¯é€»è¾‘ä¸€è‡´
5. **Token å­˜å‚¨**: åŒæ—¶ä½¿ç”¨ localStorage å’Œ Pinia storeï¼Œç¡®ä¿åˆ·æ–°é¡µé¢åè®¤è¯çŠ¶æ€ä¸ä¸¢å¤±

## ç›¸å…³æ–‡ä»¶

- `frontend/src/api/request.ts`: API è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨
- `frontend/src/stores/auth.ts`: è®¤è¯çŠ¶æ€ç®¡ç†
- `frontend/src/router/index.ts`: è·¯ç”±å®ˆå«
- `frontend/src/main.ts`: åº”ç”¨åˆå§‹åŒ–å’Œå…¨å±€é”™è¯¯å¤„ç†
- `frontend/src/utils/auth.ts`: è®¤è¯å·¥å…·å‡½æ•°
- `frontend/src/views/Auth/Login.vue`: ç™»å½•é¡µé¢

## åç»­ä¼˜åŒ–å»ºè®®

1. **Token åˆ·æ–°é˜Ÿåˆ—**: å®ç°è¯·æ±‚é˜Ÿåˆ—ï¼Œé¿å…å¹¶å‘åˆ·æ–°
2. **ç¦»çº¿æ¨¡å¼**: æ”¯æŒç¦»çº¿ç¼“å­˜ï¼Œç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥
3. **å¤šæ ‡ç­¾é¡µåŒæ­¥**: ä½¿ç”¨ BroadcastChannel æˆ– localStorage äº‹ä»¶åŒæ­¥å¤šæ ‡ç­¾é¡µçš„è®¤è¯çŠ¶æ€
4. **å®‰å…¨å¢å¼º**: å®ç° CSRF ä¿æŠ¤ã€XSS é˜²æŠ¤ç­‰å®‰å…¨æªæ–½
5. **ç›‘æ§å’Œæ—¥å¿—**: é›†æˆå‰ç«¯ç›‘æ§æœåŠ¡ï¼Œè®°å½•è®¤è¯ç›¸å…³çš„é”™è¯¯å’Œå¼‚å¸¸

