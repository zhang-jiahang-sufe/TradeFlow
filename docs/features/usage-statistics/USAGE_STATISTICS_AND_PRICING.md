# ä½¿ç”¨ç»Ÿè®¡ä¸å®šä»·é…ç½®åŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» TradingAgents-CN çš„ä½¿ç”¨ç»Ÿè®¡å’Œå®šä»·é…ç½®åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **æ¨¡å‹å®šä»·é…ç½®** - ä¸ºæ¯ä¸ªå¤§æ¨¡å‹é…ç½®è¾“å…¥/è¾“å‡º token ä»·æ ¼
2. **ä½¿ç”¨ç»Ÿè®¡** - æŸ¥çœ‹æ¨¡å‹ä½¿ç”¨æƒ…å†µå’Œæˆæœ¬ç»Ÿè®¡
3. **è®¡è´¹åˆ†æ** - æŒ‰ä¾›åº”å•†ã€æ¨¡å‹ã€æ—¥æœŸåˆ†ææˆæœ¬

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. æ¨¡å‹å®šä»·é…ç½®

#### åœ¨å¤§æ¨¡å‹é…ç½®ä¸­è®¾ç½®å®šä»·

åœ¨"é…ç½®ç®¡ç† > å¤§æ¨¡å‹é…ç½®"ä¸­ï¼Œæ¯ä¸ªæ¨¡å‹å¡ç‰‡ä¼šæ˜¾ç¤ºå®šä»·ä¿¡æ¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–¥ï¸ qwen-max                  âœ… å¯ç”¨ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Token: 4000                         â”‚
â”‚ æ¸©åº¦: 0.7                           â”‚
â”‚ è¶…æ—¶: 60s                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’° å®šä»·:                            â”‚
â”‚   è¾“å…¥: 0.0200 CNY/1K               â”‚
â”‚   è¾“å‡º: 0.0600 CNY/1K               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼–è¾‘å®šä»·

ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®ï¼Œåœ¨å¯¹è¯æ¡†ä¸­å¯ä»¥é…ç½®ï¼š

- **è¾“å…¥ä»·æ ¼** (input_price_per_1k): æ¯ 1000 ä¸ªè¾“å…¥ token çš„ä»·æ ¼
- **è¾“å‡ºä»·æ ¼** (output_price_per_1k): æ¯ 1000 ä¸ªè¾“å‡º token çš„ä»·æ ¼
- **è´§å¸å•ä½** (currency): CNY(äººæ°‘å¸) / USD(ç¾å…ƒ) / EUR(æ¬§å…ƒ)

### 2. ä½¿ç”¨ç»Ÿè®¡ç•Œé¢

è®¿é—®"è®¾ç½® > ä½¿ç”¨ç»Ÿè®¡"æŸ¥çœ‹è¯¦ç»†çš„ä½¿ç”¨å’Œè®¡è´¹ä¿¡æ¯ã€‚

#### ç»Ÿè®¡æ¦‚è§ˆ

æ˜¾ç¤ºå…³é”®æŒ‡æ ‡ï¼š
- æ€»è¯·æ±‚æ•°
- æ€»è¾“å…¥ Token
- æ€»è¾“å‡º Token
- æ€»æˆæœ¬

#### å›¾è¡¨åˆ†æ

1. **æŒ‰ä¾›åº”å•†ç»Ÿè®¡** (é¥¼å›¾)
   - æ˜¾ç¤ºå„ä¾›åº”å•†çš„æˆæœ¬å æ¯”
   - å¿«é€Ÿè¯†åˆ«ä¸»è¦æˆæœ¬æ¥æº

2. **æŒ‰æ¨¡å‹ç»Ÿè®¡** (æŸ±çŠ¶å›¾)
   - æ˜¾ç¤ºå‰ 10 ä¸ªæ¨¡å‹çš„æˆæœ¬
   - å¯¹æ¯”ä¸åŒæ¨¡å‹çš„ä½¿ç”¨æˆæœ¬

3. **æ¯æ—¥æˆæœ¬è¶‹åŠ¿** (æŠ˜çº¿å›¾)
   - æ˜¾ç¤ºæ¯æ—¥æˆæœ¬å˜åŒ–
   - åˆ†ææˆæœ¬è¶‹åŠ¿

#### ä½¿ç”¨è®°å½•è¡¨æ ¼

è¯¦ç»†è®°å½•æ¯æ¬¡ API è°ƒç”¨ï¼š
- æ—¶é—´
- ä¾›åº”å•†
- æ¨¡å‹
- è¾“å…¥/è¾“å‡º Token
- æˆæœ¬
- åˆ†æç±»å‹
- ä¼šè¯ ID

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯ API

#### ä½¿ç”¨ç»Ÿè®¡æœåŠ¡

```python
# app/services/usage_statistics_service.py
class UsageStatisticsService:
    async def add_usage_record(record: UsageRecord) -> bool
    async def get_usage_records(...) -> List[UsageRecord]
    async def get_usage_statistics(...) -> UsageStatistics
    async def get_cost_by_provider(days: int) -> Dict[str, float]
    async def get_cost_by_model(days: int) -> Dict[str, float]
    async def get_daily_cost(days: int) -> Dict[str, float]
```

#### API ç«¯ç‚¹

```
GET  /api/usage/records          # è·å–ä½¿ç”¨è®°å½•
GET  /api/usage/statistics       # è·å–ä½¿ç”¨ç»Ÿè®¡
GET  /api/usage/cost/by-provider # æŒ‰ä¾›åº”å•†ç»Ÿè®¡æˆæœ¬
GET  /api/usage/cost/by-model    # æŒ‰æ¨¡å‹ç»Ÿè®¡æˆæœ¬
GET  /api/usage/cost/daily       # æ¯æ—¥æˆæœ¬ç»Ÿè®¡
DELETE /api/usage/records/old    # åˆ é™¤æ—§è®°å½•
```

### å‰ç«¯ç»„ä»¶

#### ä½¿ç”¨ç»Ÿè®¡é¡µé¢

```
frontend/src/views/Settings/UsageStatistics.vue
```

åŠŸèƒ½ï¼š
- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
- ECharts å›¾è¡¨å±•ç¤º
- ä½¿ç”¨è®°å½•è¡¨æ ¼
- æ—¶é—´èŒƒå›´ç­›é€‰

#### é…ç½®ç®¡ç†å¢å¼º

```
frontend/src/views/Settings/ConfigManagement.vue
frontend/src/views/Settings/components/LLMConfigDialog.vue
```

æ–°å¢ï¼š
- æ¨¡å‹å¡ç‰‡æ˜¾ç¤ºå®šä»·ä¿¡æ¯
- ç¼–è¾‘å¯¹è¯æ¡†æ·»åŠ å®šä»·é…ç½®å­—æ®µ

### æ•°æ®æ¨¡å‹

#### LLMConfig æ‰©å±•

```python
class LLMConfig(BaseModel):
    # ... åŸæœ‰å­—æ®µ ...
    
    # å®šä»·é…ç½®
    input_price_per_1k: Optional[float] = None
    output_price_per_1k: Optional[float] = None
    currency: str = "CNY"
```

#### UsageRecord

```python
class UsageRecord(BaseModel):
    timestamp: str
    provider: str
    model_name: str
    input_tokens: int
    output_tokens: int
    cost: float
    session_id: str
    analysis_type: str
```

#### UsageStatistics

```python
class UsageStatistics(BaseModel):
    total_requests: int
    total_input_tokens: int
    total_output_tokens: int
    total_cost: float
    by_provider: Dict[str, Any]
    by_model: Dict[str, Any]
    by_date: Dict[str, Any]
```

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### 1. é…ç½®æ¨¡å‹å®šä»·

```python
# é€šè¿‡ API æ›´æ–°æ¨¡å‹é…ç½®
llm_config = {
    "provider": "dashscope",
    "model_name": "qwen-max",
    "input_price_per_1k": 0.02,    # 2åˆ†/1K tokens
    "output_price_per_1k": 0.06,   # 6åˆ†/1K tokens
    "currency": "CNY"
}

await config_service.update_llm_config(llm_config)
```

### 2. æŸ¥è¯¢ä½¿ç”¨ç»Ÿè®¡

```python
# è·å–æœ€è¿‘ 7 å¤©çš„ç»Ÿè®¡
stats = await usage_statistics_service.get_usage_statistics(days=7)

print(f"æ€»è¯·æ±‚æ•°: {stats.total_requests}")
print(f"æ€»æˆæœ¬: Â¥{stats.total_cost:.4f}")

# æŒ‰ä¾›åº”å•†ç»Ÿè®¡
for provider, data in stats.by_provider.items():
    print(f"{provider}: Â¥{data['cost']:.4f}")
```

### 3. å‰ç«¯è°ƒç”¨

```typescript
// è·å–ä½¿ç”¨ç»Ÿè®¡
import { getUsageStatistics } from '@/api/usage'

const stats = await getUsageStatistics({ days: 7 })
console.log('æ€»æˆæœ¬:', stats.data.data.total_cost)
```

## ğŸ¨ ç•Œé¢æˆªå›¾

### æ¨¡å‹å®šä»·é…ç½®

åœ¨å¤§æ¨¡å‹é…ç½®å¡ç‰‡ä¸­æ˜¾ç¤ºå®šä»·ä¿¡æ¯ï¼Œç‚¹å‡»"ç¼–è¾‘"å¯ä»¥ä¿®æ”¹ã€‚

### ä½¿ç”¨ç»Ÿè®¡ä»ªè¡¨æ¿

- é¡¶éƒ¨æ˜¾ç¤ºå…³é”®æŒ‡æ ‡å¡ç‰‡
- ä¸­é—´æ˜¾ç¤ºä¸‰ä¸ªå›¾è¡¨ï¼ˆä¾›åº”å•†ã€æ¨¡å‹ã€æ¯æ—¥è¶‹åŠ¿ï¼‰
- åº•éƒ¨æ˜¾ç¤ºè¯¦ç»†ä½¿ç”¨è®°å½•è¡¨æ ¼

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®šä»·é…ç½®å»ºè®®

- **åŠæ—¶æ›´æ–°**: ä¾›åº”å•†è°ƒæ•´ä»·æ ¼ååŠæ—¶æ›´æ–°é…ç½®
- **ç»Ÿä¸€è´§å¸**: å»ºè®®ç»Ÿä¸€ä½¿ç”¨äººæ°‘å¸(CNY)ä¾¿äºç»Ÿè®¡
- **ç²¾ç¡®é…ç½®**: ä»·æ ¼ç²¾ç¡®åˆ°å°æ•°ç‚¹å 4 ä½

### 2. æˆæœ¬æ§åˆ¶

- **å®šæœŸæŸ¥çœ‹**: æ¯å‘¨æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡ï¼Œäº†è§£æˆæœ¬è¶‹åŠ¿
- **è¯†åˆ«é«˜æˆæœ¬**: é€šè¿‡å›¾è¡¨å¿«é€Ÿè¯†åˆ«é«˜æˆæœ¬æ¨¡å‹
- **ä¼˜åŒ–é€‰æ‹©**: æ ¹æ®æˆæœ¬å’Œæ•ˆæœé€‰æ‹©åˆé€‚çš„æ¨¡å‹

### 3. æ•°æ®ç®¡ç†

- **å®šæœŸæ¸…ç†**: å®šæœŸåˆ é™¤ 90 å¤©å‰çš„æ—§è®°å½•
- **å¯¼å‡ºå¤‡ä»½**: é‡è¦æ•°æ®å¯ä»¥å¯¼å‡ºå¤‡ä»½
- **ç›‘æ§å¼‚å¸¸**: å…³æ³¨æˆæœ¬å¼‚å¸¸å¢é•¿

## ğŸ”’ å®‰å…¨è¯´æ˜

- ä½¿ç”¨è®°å½•å­˜å‚¨åœ¨ MongoDB ä¸­
- åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
- å®šä»·ä¿¡æ¯ä¸æ¨¡å‹é…ç½®ä¸€èµ·å­˜å‚¨
- æ”¯æŒæŒ‰ç”¨æˆ·æƒé™æ§åˆ¶è®¿é—®

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è‡ªåŠ¨è®°å½•**: TradingAgents æ ¸å¿ƒåº“ä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡ API è°ƒç”¨
2. **æˆæœ¬è®¡ç®—**: æˆæœ¬ = (è¾“å…¥ tokens / 1000) Ã— è¾“å…¥ä»·æ ¼ + (è¾“å‡º tokens / 1000) Ã— è¾“å‡ºä»·æ ¼
3. **è´§å¸è½¬æ¢**: ç³»ç»Ÿä¸è‡ªåŠ¨è½¬æ¢è´§å¸ï¼Œè¯·æ‰‹åŠ¨é…ç½®ç»Ÿä¸€è´§å¸
4. **æ•°æ®å»¶è¿Ÿ**: ç»Ÿè®¡æ•°æ®å¯èƒ½æœ‰å‡ ç§’é’Ÿå»¶è¿Ÿ

## ğŸš€ æœªæ¥è®¡åˆ’

- [ ] æˆæœ¬é¢„è­¦åŠŸèƒ½
- [ ] æˆæœ¬é¢„ç®—ç®¡ç†
- [ ] æ›´å¤šå›¾è¡¨ç±»å‹
- [ ] å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨
- [ ] æˆæœ¬ä¼˜åŒ–å»ºè®®
- [ ] å¤šç”¨æˆ·æˆæœ¬åˆ†æ‘Š

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é…ç½®ç®¡ç†æ–‡æ¡£](./CONFIG_MANAGEMENT.md)
- [API æ–‡æ¡£](./API_DOCUMENTATION.md)
- [æ•°æ®åº“è®¾è®¡](./DATABASE_SCHEMA.md)

